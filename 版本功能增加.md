### 📝 EasyBook V3.0 新增功能規格 (商用進階版) 2025.12.19

#### 1. 身分識別與 LINE 登入模組

* **設計機制**：採取「預約中段觸發」策略。用戶選定時段後，在填寫資料前需進行 LINE 授權。
* **數據綁定**：系統自動獲取並記錄用戶的 `line_uid`、頭像與顯示名稱，並將其與手機號碼進行唯一性綁定。
* **隔離確保**：利用 RLS 確保用戶僅能透過自己的 LINE ID 查詢到自己的預約紀錄。

#### 2. 預約防護：智能緩衝期 (Lead Time)

* **營運規則**：店家可於後台設定 `min_lead_hours` (預約前置小時數)。
* **動態遮蔽**：`booking.html` 產生時段時，自動過濾掉 `當前時間 + 緩衝小時` 以內的選項，防止凌晨預約、早上報到的突發狀況。

#### 3. 視覺化店家排假系統

* **交互設計**：於 `admin.html` 整合「日曆選取模式」，支援滑鼠點擊日期進行「全店店休」或「特定老師排休」。
* **批次寫入**：選取日期後，系統批量在 `bookings` 表寫入 `status: 'blocked'` 紀錄，即時更新前台預約空檔。

#### 4. 客戶 CRM 與黑名單防護

* **客戶畫像**：在老師端 (`staff.html`) 與老闆端 (`admin.html`) 顯示客戶預約頻率、失約紀錄。
* **黑名單機制**：針對特定 `line_uid` 或手機號碼標記為 `is_blacklisted`。被標記用戶在前端預約時，系統將自動隱藏可用時段或提示「時段已售完」。

#### 5. 專業病歷/諮詢備註模組 (物理治療專用)

* **數據結構**：建立 `consultation_notes` 表，關聯客戶與老師，支援文字與圖片紀錄。
* **歷史調閱**：老師在 `staff.html` 處理預約時，可一鍵調用該用戶過去的所有治療備註與進度紀錄。
* **安全隔離**：套用 RLS 權限，僅允許服務過該客戶的老師或具備管理者權限者查看敏感紀錄。
