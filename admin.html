<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EasyBook å•†å®¶å¾Œå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 text-sm md:text-base">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // â˜… Supabase è¨­å®š
        const supabaseUrl = 'https://kwvbhzjzysmivafsvwng.supabase.co';
        const supabaseKey = 'sb_publishable_7RUbenk2kXNDmvuo1XtHbQ_m0RjXuZr'; 
        const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

        // â˜… å·¥å…·ï¼šç”Ÿæˆæ™‚æ®µ
        const generateTimeSlots = (openTime = "09:00", closeTime = "21:00") => {
            const slots = [];
            const [openH, openM] = openTime.split(':').map(Number);
            const [closeH, closeM] = closeTime.split(':').map(Number);
            let startMinutes = openH * 60 + openM;
            let endMinutes = closeH * 60 + closeM;
            if (endMinutes < startMinutes) endMinutes += 24 * 60;
            for (let m = startMinutes; m < endMinutes; m += 30) {
                let h = Math.floor(m / 60);
                let min = m % 60;
                let isNextDay = false;
                if (h >= 24) { h -= 24; isNextDay = true; }
                const timeStr = `${h.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
                slots.push({ time: timeStr, isNextDay, label: isNextDay ? `${timeStr} (éš”æ—¥)` : timeStr, sortValue: m });
            }
            return slots;
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && window.lucide) {
                    ref.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    i.setAttribute('width', size);
                    i.setAttribute('height', size);
                    if (className) i.setAttribute('class', className);
                    ref.current.appendChild(i);
                    window.lucide.createIcons({ root: ref.current });
                }
            }, [name, size, className]);
            return <span ref={ref} className="inline-flex items-center justify-center"></span>;
        };

        const MobileCard = ({ title, subtitle, status, actions, children }) => (
            <div className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm mb-3">
                <div className="flex justify-between items-start mb-2">
                    <div><h4 className="font-bold text-slate-800 text-lg">{title}</h4>{subtitle && <p className="text-sm text-slate-500">{subtitle}</p>}</div>
                    {status && <div className="flex-shrink-0 ml-2">{status}</div>}
                </div>
                {children && <div className="text-sm text-slate-600 mb-3 space-y-1">{children}</div>}
                {actions && <div className="flex justify-end gap-2 pt-2 border-t border-slate-50">{actions}</div>}
            </div>
        );

        // --- 1. å„€è¡¨æ¿ (Dashboard) ---
        function DashboardView({ supabase, storeId }) {
            const [bookings, setBookings] = useState([]);
            const [services, setServices] = useState([]);
            const [loading, setLoading] = useState(false);
            const [tab, setTab] = useState('bookings');
            const [timeFilter, setTimeFilter] = useState('today');

            useEffect(() => { fetchData(); }, [storeId]);

            async function fetchData() {
                setLoading(true);
                const { data: bData, error: bError } = await supabase.from('bookings').select('*').eq('store_id', storeId).order('booking_date').order('booking_time');
                if (bError) console.error("Bookings Fetch Error:", bError);

                const { data: sData, error: sError } = await supabase.from('services').select('name, price').eq('store_id', storeId);
                if (sError) console.error("Services Fetch Error:", sError);

                setBookings(bData || []);
                setServices(sData || []);
                setLoading(false);
            }

            async function updateStatus(id, newStatus) {
                if(!confirm(`ç¢ºå®šæ›´æ”¹ç‹€æ…‹ç‚ºã€Œ${newStatus}ã€ï¼Ÿ`)) return;
                const { error } = await supabase.rpc('owner_update_booking', {
                    p_store_id: storeId, p_booking_id: id, p_new_status: newStatus
                });
                if (error) alert("æ›´æ–°å¤±æ•—: " + error.message);
                else {
                    alert("æ›´æ–°æˆåŠŸï¼");
                    fetchData();
                }
            }

            // åˆä½µé¡¯ç¤ºé‚è¼¯ (ç”¨æ–¼ Dashboard åˆ—è¡¨)
            const mergeLeaveSlots = (leaves) => {
                if (leaves.length === 0) return [];
                const sorted = [...leaves].sort((a, b) => a.booking_time.localeCompare(b.booking_time));
                const merged = [];
                let currentGroup = null;
                sorted.forEach((leave) => {
                    if (currentGroup && currentGroup.staff_name === leave.staff_name && currentGroup.booking_date === leave.booking_date && currentGroup.reason === leave.customer_name) {
                        currentGroup.endTime = leave.booking_time; 
                        currentGroup.ids.push(leave.id);
                    } else {
                        if (currentGroup) merged.push(currentGroup);
                        currentGroup = {
                            id: leave.id, ids: [leave.id], 
                            staff_name: leave.staff_name, booking_date: leave.booking_date,
                            startTime: leave.booking_time, endTime: leave.booking_time, 
                            reason: leave.customer_name 
                        };
                    }
                });
                if (currentGroup) merged.push(currentGroup);
                return merged;
            };

            async function batchCancelLeave(ids) {
                if(!confirm(`ç¢ºå®šè¦å–æ¶ˆé€™ ${ids.length} å€‹æ’ä¼‘æ™‚æ®µå—ï¼Ÿ`)) return;
                let errorCount = 0;
                for (const id of ids) {
                    const { error } = await supabase.rpc('owner_update_booking', {
                        p_store_id: storeId, p_booking_id: id, p_new_status: 'cancelled'
                    });
                    if(error) errorCount++;
                }
                if(errorCount > 0) alert(`æœ‰ ${errorCount} ç­†åˆªé™¤å¤±æ•—`);
                else alert("åˆªé™¤æˆåŠŸï¼");
                fetchData();
            }

            const stats = useMemo(() => {
                const today = new Date().toISOString().split('T')[0];
                const tmr = new Date(); tmr.setDate(tmr.getDate()+1);
                const tmrStr = tmr.toISOString().split('T')[0];

                let displayList = bookings.filter(b => {
                    if(b.status === 'cancelled') return false;
                    if(timeFilter === 'today') return b.booking_date === today;
                    if(timeFilter === 'tomorrow') return b.booking_date === tmrStr;
                    return true;
                });

                const bookingList = displayList.filter(b => b.status !== 'blocked');
                const leaveList = mergeLeaveSlots(displayList.filter(b => b.status === 'blocked'));

                let todayRev = 0, monthRev = 0, monthCount = 0;
                bookings.forEach(b => {
                    if (['confirmed', 'completed'].includes(b.status)) {
                        const price = services.find(s => s.name === b.service_name)?.price || 0;
                        if (b.booking_date === today) todayRev += price;
                        if (b.booking_date.startsWith(today.slice(0, 7))) { monthRev += price; monthCount++; }
                    }
                });
                return { todayRev, monthRev, monthCount, bookingList, leaveList };
            }, [bookings, services, timeFilter]);

            return (
                <div className="space-y-4 md:space-y-6 pb-20 animate-fade-in-up">
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
                        <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100"><p className="text-xs text-slate-400 font-bold mb-1">ä»Šæ—¥ç‡Ÿæ”¶</p><h3 className="text-xl md:text-2xl font-black text-emerald-600">${stats.todayRev.toLocaleString()}</h3></div>
                        <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100"><p className="text-xs text-slate-400 font-bold mb-1">æœ¬æœˆç‡Ÿæ”¶</p><h3 className="text-xl md:text-2xl font-black text-slate-800">${stats.monthRev.toLocaleString()}</h3></div>
                        <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100"><p className="text-xs text-slate-400 font-bold mb-1">æœ¬æœˆè¨‚å–®</p><h3 className="text-xl md:text-2xl font-black text-slate-800">{stats.monthCount}</h3></div>
                        <div className="bg-slate-800 text-white p-4 rounded-2xl shadow-lg flex flex-col justify-center items-center"><p className="text-xs opacity-60 mb-1">å¾…è™•ç†é ç´„</p><h3 className="text-2xl font-bold">{stats.bookingList.filter(b=>b.status==='confirmed').length}</h3></div>
                    </div>

                    <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden flex flex-col min-h-[500px]">
                        <div className="p-4 border-b border-slate-100 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-slate-50">
                            <div className="flex bg-white p-1 rounded-lg border border-slate-200 w-full md:w-auto">
                                <button onClick={() => setTab('bookings')} className={`flex-1 md:flex-none px-4 py-2 rounded-md text-sm font-bold transition ${tab === 'bookings' ? 'bg-slate-100 text-slate-800' : 'text-slate-400'}`}>å®¢æˆ¶é ç´„</button>
                                <button onClick={() => setTab('leaves')} className={`flex-1 md:flex-none px-4 py-2 rounded-md text-sm font-bold transition ${tab === 'leaves' ? 'bg-red-50 text-red-600' : 'text-slate-400'}`}>äººå“¡æ’ä¼‘</button>
                            </div>
                            <div className="flex gap-2 w-full md:w-auto">
                                <select value={timeFilter} onChange={e => setTimeFilter(e.target.value)} className="bg-white border border-slate-200 text-slate-700 text-sm rounded-lg p-2 font-bold outline-none flex-1 md:flex-none"><option value="today">ğŸ“… ä»Šæ—¥</option><option value="tomorrow">ğŸŒ¤ æ˜æ—¥</option><option value="all">ğŸ“š å…¨éƒ¨</option></select>
                                <button onClick={fetchData} className="p-2 text-slate-400 hover:bg-slate-100 rounded-lg"><Icon name="refresh-cw" size={18}/></button>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 bg-slate-50 md:bg-white custom-scrollbar">
                            {loading ? <div className="flex items-center justify-center h-40 text-slate-400"><Icon name="loader" className="animate-spin mr-2"/> è¼‰å…¥ä¸­...</div> : 
                             tab === 'bookings' ? (
                                stats.bookingList.length === 0 ? <div className="text-center p-10 text-slate-400">ç›®å‰æ²’æœ‰é ç´„è³‡æ–™</div> :
                                <>
                                    <div className="hidden md:block">
                                        <table className="w-full text-left text-sm">
                                            <thead className="bg-slate-50 text-slate-500 text-xs uppercase font-bold"><tr><th className="p-3">æ™‚é–“</th><th className="p-3">å®¢æˆ¶</th><th className="p-3">é …ç›®</th><th className="p-3">ç‹€æ…‹</th><th className="p-3 text-right">æ“ä½œ</th></tr></thead>
                                            <tbody className="divide-y divide-slate-50">
                                                {stats.bookingList.map(b => (
                                                    <tr key={b.id} className="hover:bg-slate-50">
                                                        <td className="p-3"><div className="font-bold">{b.booking_time}</div><div className="text-xs text-slate-400">{b.booking_date}</div></td>
                                                        <td className="p-3"><div className="font-bold">{b.customer_name}</div><div className="text-xs text-slate-400">{b.customer_phone}</div></td>
                                                        <td className="p-3"><span className="bg-emerald-50 text-emerald-700 px-2 py-1 rounded text-xs font-bold">{b.service_name}</span><div className="text-xs text-slate-400 mt-1">{b.staff_name}</div></td>
                                                        <td className="p-3">{b.status === 'confirmed' ? <span className="text-emerald-600 font-bold">â— ç¢ºèª</span> : <span className="text-slate-400">{b.status}</span>}</td>
                                                        <td className="p-3 text-right">{b.status === 'confirmed' && <button onClick={() => updateStatus(b.id, 'cancelled')} className="text-red-400 hover:text-red-600"><Icon name="x-circle" size={18}/></button>}</td>
                                                    </tr>))}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div className="md:hidden space-y-3">
                                        {stats.bookingList.map(b => (
                                            <MobileCard key={b.id} title={`${b.booking_time} ${b.customer_name}`} subtitle={b.booking_date} status={b.status === 'confirmed' ? <span className="text-emerald-600 font-bold text-xs bg-emerald-50 px-2 py-1 rounded">â— ç¢ºèª</span> : <span className="text-slate-400 text-xs bg-slate-100 px-2 py-1 rounded">{b.status}</span>} actions={b.status === 'confirmed' && <button onClick={() => updateStatus(b.id, 'cancelled')} className="text-red-500 font-bold text-xs px-3 py-2 bg-red-50 rounded-lg w-full">å–æ¶ˆé ç´„</button>}>
                                                <div className="flex justify-between"><span>é …ç›®:</span> <span className="font-bold">{b.service_name}</span></div>
                                                <div className="flex justify-between"><span>è€å¸«:</span> <span>{b.staff_name}</span></div>
                                            </MobileCard>
                                        ))}
                                    </div>
                                </>
                            ) : (
                                stats.leaveList.length === 0 ? <div className="text-center p-10 text-slate-400">æ²’æœ‰æ’ä¼‘ç´€éŒ„</div> :
                                stats.leaveList.map(g => (
                                    <div key={g.id} className="flex justify-between items-center p-3 border-b border-slate-200 bg-white md:bg-transparent rounded-xl md:rounded-none mb-2 md:mb-0 shadow-sm md:shadow-none">
                                        <div className="flex items-center">
                                            <div className="bg-red-50 text-red-600 p-2 rounded-lg font-bold mr-3 text-xs md:text-sm">{g.startTime} ~ {g.endTime}</div>
                                            <div><div className="font-bold text-slate-700">{g.staff_name}</div><div className="text-xs text-slate-400">{g.reason} ({g.booking_date})</div></div>
                                        </div>
                                        <button onClick={() => batchCancelLeave(g.ids)} className="text-red-400 hover:text-red-600 p-2 bg-slate-50 rounded-lg"><Icon name="trash-2" size={18}/></button>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // --- 2. æ’ç­ç®¡ç† (Schedule) [â˜… UX å‡ç´šç‰ˆ] ---
        function ScheduleManager({ supabase, storeId }) {
            const [staffList, setStaffList] = useState([]);
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [selectedStaff, setSelectedStaff] = useState(null);
            const [scheduleData, setScheduleData] = useState([]);
            const [showModal, setShowModal] = useState(false);
            
            // UX å‡ç´šï¼šæ–°å¢æ™‚æ®µé¸æ“‡ç‹€æ…‹
            const [leaveType, setLeaveType] = useState('staff');
            const [timeMode, setTimeMode] = useState('all'); // all | custom
            const [startTime, setStartTime] = useState('09:00');
            const [endTime, setEndTime] = useState('18:00');
            const [reason, setReason] = useState('å…¬ä¼‘');
            
            const [timeSlots, setTimeSlots] = useState([]);

            useEffect(() => { fetchStaff(); fetchStoreInfo(); }, [storeId]);
            useEffect(() => { fetchSchedule(); }, [selectedDate, storeId]);

            async function fetchStoreInfo() {
                const { data } = await supabase.from('stores').select('open_time, close_time').eq('id', storeId).single();
                if (data) {
                    setTimeSlots(generateTimeSlots(data.open_time, data.close_time));
                    // é è¨­æ™‚é–“
                    setStartTime(data.open_time);
                    setEndTime(data.close_time);
                }
            }

            async function fetchStaff() {
                const { data, error } = await supabase.from('staff').select('*').eq('store_id', storeId).is('deleted_at', null);
                if (error) console.error("Fetch Staff Error:", error);
                if (data) { setStaffList(data); if(data.length>0) setSelectedStaff(data[0]); }
            }

            async function fetchSchedule() {
                const start = new Date(selectedDate); start.setDate(1); 
                const end = new Date(start); end.setMonth(end.getMonth()+1);
                const { data } = await supabase.from('bookings').select('id, booking_date, booking_time, staff_name, status, customer_name')
                    .eq('store_id', storeId)
                    .gte('booking_date', start.toISOString().split('T')[0])
                    .lt('booking_date', end.toISOString().split('T')[0])
                    .eq('status', 'blocked');
                setScheduleData(data || []);
            }

            // â˜… ä¿®æ­£ï¼šè¡çªæª¢æ¸¬é‚è¼¯
            const handleBulkLeave = async () => {
                const targets = leaveType === 'store' ? staffList : [selectedStaff];
                if (targets.length === 0 || !targets[0]) return alert("è«‹å…ˆæ–°å¢å“¡å·¥");

                const items = [];
                // è¨ˆç®—æ™‚æ®µå€é–“
                let targetSlots = timeSlots;
                if (timeMode === 'custom') {
                    // ç°¡å–®å­—ä¸²æ¯”å°ï¼Œå‡è¨­æ™‚é–“æ ¼å¼å›ºå®š HH:MM
                    targetSlots = timeSlots.filter(s => s.time >= startTime && s.time < endTime); 
                }

                // 1. ç”¢ç”Ÿæ‰€æœ‰æ¬²è«‹å‡çš„é …ç›®
                targets.forEach(staff => {
                    targetSlots.forEach(slot => {
                        let bDate = selectedDate;
                        if (slot.isNextDay) { const d = new Date(selectedDate); d.setDate(d.getDate()+1); bDate = d.toISOString().split('T')[0]; }
                        items.push({ staff_name: staff.name, booking_date: bDate, booking_time: slot.time, reason: reason });
                    });
                });

                if(items.length === 0) return alert("ç„¡æœ‰æ•ˆæ™‚æ®µ");

                // 2. è¡çªæª¢æ¸¬ï¼šæŸ¥è©¢è³‡æ–™åº«æ˜¯å¦æœ‰ 'confirmed' çš„è¨‚å–®
                // ç‚ºäº†æ•ˆèƒ½ï¼Œæˆ‘å€‘æŸ¥è©²æ—¥æœŸçš„æ‰€æœ‰ confirmed è¨‚å–®ï¼Œå†ç”¨ JS æ¯”å°
                const checkDates = [...new Set(items.map(i => i.booking_date))];
                const { data: conflicts } = await supabase.from('bookings').select('staff_name, booking_date, booking_time, customer_name')
                    .eq('store_id', storeId)
                    .in('booking_date', checkDates)
                    .eq('status', 'confirmed');

                if (conflicts && conflicts.length > 0) {
                    const foundConflict = items.find(item => 
                        conflicts.some(c => c.staff_name === item.staff_name && c.booking_date === item.booking_date && c.booking_time === item.booking_time)
                    );

                    if (foundConflict) {
                        const conflictInfo = conflicts.find(c => c.staff_name === foundConflict.staff_name && c.booking_date === foundConflict.booking_date && c.booking_time === foundConflict.booking_time);
                        return alert(`â›” ç„¡æ³•æ’ä¼‘ï¼\n\n${foundConflict.staff_name} åœ¨ ${foundConflict.booking_time} å·²æœ‰é ç´„ã€‚\nå®¢æˆ¶ï¼š${conflictInfo.customer_name}\n\nè«‹å…ˆæ‰‹å‹•å–æ¶ˆè©²é ç´„ï¼Œæ‰èƒ½è¨­å®šä¼‘å‡ã€‚`);
                    }
                }

                // 3. é€šéæª¢æ¸¬ï¼ŒåŸ·è¡Œç¢ºèªèˆ‡å¯«å…¥
                if (!confirm(`å³å°‡æ–°å¢ ${items.length} ç­†æ’ä¼‘ï¼Œç¢ºå®šå—ï¼Ÿ`)) return;

                const { error } = await supabase.rpc('owner_batch_block_time', { p_store_id: storeId, p_payload: items });
                if (error) alert("å¤±æ•—: " + error.message); else { alert("âœ… æ’ä¼‘è¨­å®šå®Œæˆï¼"); setShowModal(false); fetchSchedule(); }
            };

            // â˜… æ‰¹é‡åˆªé™¤é‚è¼¯
            async function batchCancelLeave(ids) {
                if(!confirm(`ç¢ºå®šç§»é™¤é€™ ${ids.length} å€‹æ™‚æ®µï¼Ÿ`)) return;
                let errorCount = 0;
                for (const id of ids) {
                    const { error } = await supabase.rpc('owner_update_booking', {
                        p_store_id: storeId, p_booking_id: id, p_new_status: 'cancelled'
                    });
                    if(error) errorCount++;
                }
                if(errorCount > 0) alert("éƒ¨åˆ†åˆªé™¤å¤±æ•—"); else fetchSchedule();
            }

            // åˆä½µé¡¯ç¤ºé‚è¼¯ (Reuse)
            const mergeLeaveSlots = (leaves) => {
                if (leaves.length === 0) return [];
                const sorted = [...leaves].sort((a, b) => a.booking_time.localeCompare(b.booking_time));
                const merged = [];
                let currentGroup = null;
                sorted.forEach((leave) => {
                    if (currentGroup && currentGroup.staff_name === leave.staff_name && currentGroup.booking_date === leave.booking_date && currentGroup.reason === leave.customer_name) {
                        currentGroup.endTime = leave.booking_time; // é€™è£¡å¯ä»¥å„ªåŒ–æˆ +30min
                        currentGroup.ids.push(leave.id);
                    } else {
                        if (currentGroup) merged.push(currentGroup);
                        currentGroup = {
                            id: leave.id, ids: [leave.id], 
                            staff_name: leave.staff_name, booking_date: leave.booking_date,
                            startTime: leave.booking_time, endTime: leave.booking_time, 
                            reason: leave.customer_name 
                        };
                    }
                });
                if (currentGroup) merged.push(currentGroup);
                return merged;
            };

            const currentDayLeavesRaw = scheduleData.filter(s => s.booking_date === selectedDate);
            const currentDayLeavesMerged = mergeLeaveSlots(currentDayLeavesRaw);

            const renderCalendar = () => {
                const year = parseInt(selectedDate.split('-')[0]);
                const month = parseInt(selectedDate.split('-')[1]) - 1;
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const startingDay = new Date(year, month, 1).getDay();
                
                const days = [];
                for (let i = 0; i < startingDay; i++) days.push(<div key={`empty-${i}`} className="h-20 md:h-28 border bg-gray-50"></div>);
                for (let d = 1; d <= daysInMonth; d++) {
                    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const dayLeaves = scheduleData.filter(x => x.booking_date === dateStr);
                    const totalCapacity = staffList.length * timeSlots.length;
                    
                    // UX: å…¨åº—å…¬ä¼‘åˆ¤å®š (è¶…é 80% ç”¢èƒ½è¢«é–)
                    const isFullStoreLeave = totalCapacity > 0 && dayLeaves.length >= (totalCapacity * 0.8);
                    
                    // UX: äººå“¡æ’ä¼‘çµ±è¨ˆ
                    const staffLeaveCounts = {};
                    dayLeaves.forEach(l => { staffLeaveCounts[l.staff_name] = (staffLeaveCounts[l.staff_name] || 0) + 1; });
                    const offStaffNames = Object.keys(staffLeaveCounts).filter(name => staffLeaveCounts[name] > 4); // ä¼‘è¶…é2å°æ™‚æ‰ç®—ä¼‘

                    days.push(
                        <div key={d} onClick={() => { setSelectedDate(dateStr); setShowModal(true); }} className={`h-20 md:h-28 border p-1 cursor-pointer hover:bg-slate-50 relative transition hover:shadow-md ${selectedDate === dateStr ? 'ring-2 ring-emerald-500' : ''} ${isFullStoreLeave ? 'bg-red-50' : 'bg-white'}`}>
                            <span className={`text-xs font-bold ${isFullStoreLeave ? 'text-red-600' : 'text-slate-700'}`}>{d}</span>
                            
                            {isFullStoreLeave ? 
                                <div className="mt-2 flex justify-center"><span className="bg-red-100 text-red-600 text-[10px] px-2 py-1 rounded-full font-bold">â›” å…¨åº—å…¬ä¼‘</span></div> 
                                : 
                                <div className="mt-1 flex flex-wrap gap-1 content-start">
                                    {offStaffNames.length > 2 ? 
                                        <span className="bg-slate-100 text-slate-500 text-[10px] px-1.5 py-0.5 rounded-md border border-slate-200">ğŸ‘¥ {offStaffNames.length}äººä¼‘å‡</span> 
                                        : 
                                        offStaffNames.map(name => <span key={name} className="bg-slate-100 text-slate-500 text-[10px] px-1.5 py-0.5 rounded-md border border-slate-200 truncate max-w-full">ğŸ’¤ {name}</span>)
                                    }
                                </div>
                            }
                            <div className="md:hidden absolute bottom-1 right-1 flex gap-1">
                                {dayLeaves.length > 0 && !isFullStoreLeave && <div className="w-1.5 h-1.5 rounded-full bg-orange-400"></div>}
                                {isFullStoreLeave && <div className="w-1.5 h-1.5 rounded-full bg-red-500"></div>}
                            </div>
                        </div>
                    );
                }
                return days;
            };

            return (
                <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 md:p-6 pb-24 animate-fade-in-up">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="font-bold text-lg">æ’ç­æœˆæ›† ({selectedDate.slice(0, 7)})</h3>
                        <input type="month" value={selectedDate.slice(0, 7)} onChange={e => setSelectedDate(e.target.value + '-01')} className="border rounded p-2 text-sm bg-slate-50"/>
                    </div>
                    <div className="grid grid-cols-7 gap-px bg-slate-200 border border-slate-200 rounded-lg overflow-hidden">
                        {['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d => <div key={d} className="bg-slate-50 p-2 text-center text-xs font-bold text-slate-500">{d}</div>)}
                        {renderCalendar()}
                    </div>
                    
                    {showModal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md animate-fade-in-up flex flex-col max-h-[90vh]">
                                <div className="p-6 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl">
                                    <h3 className="text-xl font-bold">æ’ä¼‘è¨­å®š ({selectedDate})</h3>
                                    <button onClick={()=>setShowModal(false)} className="text-slate-400 hover:text-slate-600"><Icon name="x"/></button>
                                </div>
                                
                                <div className="p-6 overflow-y-auto custom-scrollbar">
                                    {/* 1. æ–°å¢æ’ä¼‘ (UI/UX å‡ç´š) */}
                                    <h4 className="text-sm font-bold text-slate-500 mb-3 uppercase tracking-wider">æ–°å¢æ’ä¼‘</h4>
                                    <div className="space-y-4 mb-8 bg-slate-50 p-5 rounded-2xl border border-slate-200">
                                        {/* å°è±¡é¸æ“‡ */}
                                        <div className="flex bg-white p-1 rounded-xl border border-slate-200">
                                            <button onClick={() => setLeaveType('store')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${leaveType==='store' ? 'bg-slate-800 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'}`}>ğŸ¢ å…¨åº—</button>
                                            <button onClick={() => setLeaveType('staff')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${leaveType==='staff' ? 'bg-slate-800 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'}`}>ğŸ‘¤ å€‹äºº</button>
                                        </div>
                                        {leaveType === 'staff' && <select className="w-full p-3 border rounded-xl bg-white" value={selectedStaff?.id} onChange={e => setSelectedStaff(staffList.find(s => s.id === e.target.value))}>{staffList.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}</select>}
                                        
                                        {/* æ™‚æ®µé¸æ“‡ (æ ¸å¿ƒæ”¹é€²) */}
                                        <div className="border-t border-slate-200 pt-3">
                                            <div className="flex gap-4 mb-2">
                                                <label className="flex items-center text-sm font-bold cursor-pointer"><input type="radio" name="timeMode" checked={timeMode==='all'} onChange={()=>setTimeMode('all')} className="mr-2 accent-emerald-600"/> å…¨å¤©ä¼‘å‡</label>
                                                <label className="flex items-center text-sm font-bold cursor-pointer"><input type="radio" name="timeMode" checked={timeMode==='custom'} onChange={()=>setTimeMode('custom')} className="mr-2 accent-emerald-600"/> æŒ‡å®šæ™‚æ®µ</label>
                                            </div>
                                            {timeMode === 'custom' && (
                                                <div className="flex items-center gap-2 animate-fade-in-up">
                                                    <select value={startTime} onChange={e=>setStartTime(e.target.value)} className="flex-1 p-2 border rounded-lg bg-white text-sm">{timeSlots.map(t=><option key={t.time} value={t.time}>{t.time}</option>)}</select>
                                                    <span className="text-slate-400">~</span>
                                                    <select value={endTime} onChange={e=>setEndTime(e.target.value)} className="flex-1 p-2 border rounded-lg bg-white text-sm">{timeSlots.map(t=><option key={t.time} value={t.time}>{t.time}</option>)}</select>
                                                </div>
                                            )}
                                        </div>

                                        <select className="w-full p-3 border rounded-xl bg-white" value={reason} onChange={e => setReason(e.target.value)}><option>å…¬ä¼‘</option><option>äº‹å‡</option><option>ç—…å‡</option><option>é€²ä¿®</option></select>
                                        <button onClick={handleBulkLeave} className="w-full py-3 bg-emerald-600 text-white rounded-xl font-bold shadow-lg hover:bg-emerald-700 transition active:scale-95">ç¢ºèªæ–°å¢</button>
                                    </div>

                                    {/* 2. å·²æ’ä¼‘åˆ—è¡¨ (åˆä½µé¡¯ç¤º) */}
                                    <h4 className="text-sm font-bold text-slate-500 mb-3 uppercase tracking-wider flex justify-between items-center">
                                        <span>ç•¶æ—¥å·²æ’ä¼‘</span>
                                        <span className="bg-slate-200 text-slate-600 text-xs px-2 py-0.5 rounded-full">{currentDayLeavesMerged.length}</span>
                                    </h4>
                                    <div className="space-y-2">
                                        {currentDayLeavesMerged.length === 0 ? <div className="text-center text-slate-400 text-xs py-8 border-2 border-dashed border-slate-100 rounded-xl">å°šç„¡æ’ä¼‘</div> : 
                                         currentDayLeavesMerged.map(group => (
                                            <div key={group.id} className="flex justify-between items-center p-3 border border-slate-100 rounded-xl bg-white shadow-sm hover:shadow-md transition">
                                                <div className="flex items-center">
                                                    <div className="bg-slate-100 text-slate-600 px-2 py-1 rounded-lg font-mono text-xs font-bold mr-3">{group.startTime} - {group.endTime}</div>
                                                    <div>
                                                        <div className="font-bold text-slate-800 text-sm">{group.staff_name}</div>
                                                        <div className="text-xs text-slate-400">{group.reason}</div>
                                                    </div>
                                                </div>
                                                <button onClick={()=>batchCancelLeave(group.ids)} className="text-red-400 hover:text-red-600 p-2 hover:bg-red-50 rounded-lg transition" title="åˆªé™¤æ•´æ®µ"><Icon name="trash-2" size={18}/></button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- 3. å®¢æˆ¶ç®¡ç† (CRM) [â˜… V3.15 UX å‡ç´šç‰ˆ: æ¸…å–®å¼æ•´åˆä»‹é¢] ---
        function CustomerManager({ supabase, storeId }) {
            const [customers, setCustomers] = useState([]); // åŒ…å«çµ±è¨ˆæ•¸æ“šçš„å®¢æˆ¶åˆ—è¡¨
            const [loading, setLoading] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedCustomer, setSelectedCustomer] = useState(null); // ç”¨æ–¼å½ˆçª—é¡¯ç¤º

            useEffect(() => { fetchCustomerData(); }, [storeId]);

            // â˜… æ ¸å¿ƒï¼šæ‹‰å–æ•¸æ“šä¸¦é€²è¡Œå‰ç«¯èšåˆ (Aggregation)
            async function fetchCustomerData() {
                setLoading(true);
                try {
                    // 1. å¹³è¡Œæ‹‰å– å®¢æˆ¶ã€è¨‚å–®ã€èª²ç¨‹(ç‚ºäº†åƒ¹æ ¼)
                    const [custRes, bookRes, servRes] = await Promise.all([
                        supabase.from('customers').select('*').eq('store_id', storeId),
                        supabase.from('bookings').select('*').eq('store_id', storeId).order('booking_date', { ascending: false }),
                        supabase.from('services').select('name, price').eq('store_id', storeId)
                    ]);

                    if (custRes.error) throw custRes.error;
                    
                    const rawCustomers = custRes.data || [];
                    const allBookings = bookRes.data || [];
                    const services = servRes.data || [];

                    // å»ºç«‹åƒ¹æ ¼å°ç…§è¡¨ (Service Name -> Price)
                    const priceMap = {};
                    services.forEach(s => priceMap[s.name] = s.price);

                    // 2. è¨ˆç®—çµ±è¨ˆæ•¸æ“š
                    const processed = rawCustomers.map(c => {
                        const myBookings = allBookings.filter(b => b.customer_phone === c.phone);
                        
                        let totalCount = myBookings.length;
                        let completedCount = 0;
                        let totalRevenue = 0;
                        
                        const history = myBookings.map(b => {
                            const price = priceMap[b.service_name] || 0;
                            if (['completed', 'confirmed'].includes(b.status)) {
                                if (b.status === 'completed') {
                                    completedCount++;
                                    totalRevenue += price;
                                }
                            }
                            return { ...b, price };
                        });

                        return {
                            ...c,
                            stats: { totalCount, completedCount, totalRevenue },
                            history
                        };
                    });

                    // 3. æ’åºï¼šä¾æ“šã€Œç¸½æ¶ˆè²»é¡ã€ç”±é«˜åˆ°ä½ (VVIP å„ªå…ˆ)
                    processed.sort((a, b) => b.stats.totalRevenue - a.stats.totalRevenue);

                    setCustomers(processed);

                } catch (err) {
                    console.error("CRM Error:", err);
                    alert("è®€å–å®¢æˆ¶è³‡æ–™å¤±æ•—");
                } finally {
                    setLoading(false);
                }
            }

            const filtered = customers.filter(c => 
                (c.name && c.name.includes(searchTerm)) || 
                (c.phone && c.phone.includes(searchTerm))
            );

            return (
                <div className="bg-white md:rounded-2xl shadow-sm md:border border-gray-100 p-4 md:p-6 pb-20 animate-fade-in-up">
                    <div className="mb-6 relative">
                        <input 
                            type="text" 
                            placeholder="æœå°‹å§“åæˆ–é›»è©±..." 
                            className="pl-10 pr-4 py-3 border rounded-xl text-sm bg-slate-50 w-full focus:ring-2 focus:ring-emerald-500 outline-none" 
                            value={searchTerm} 
                            onChange={e => setSearchTerm(e.target.value)} 
                        />
                        <Icon name="search" size={18} className="absolute left-3 top-3.5 text-slate-400"/>
                    </div>

                    <div className="space-y-3">
                        {loading ? <div className="text-center p-10 text-slate-400"><Icon name="loader" className="animate-spin mr-2"/> åˆ†ææ•¸æ“šä¸­...</div> : 
                         filtered.length === 0 ? <div className="text-center p-10 text-slate-400">ç„¡å®¢æˆ¶è³‡æ–™</div> :
                         filtered.map(c => (
                            <div key={c.id} onClick={() => setSelectedCustomer(c)} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm hover:border-emerald-300 transition cursor-pointer group flex justify-between items-center">
                                <div className="flex items-center">
                                    <div className="w-12 h-12 rounded-full bg-slate-100 overflow-hidden mr-4 flex-shrink-0 border border-slate-200">
                                        {c.avatar_url ? <img src={c.avatar_url} className="w-full h-full object-cover"/> : <div className="flex items-center justify-center h-full text-slate-300"><Icon name="user" size={20}/></div>}
                                    </div>
                                    <div>
                                        <div className="font-bold text-slate-800 text-lg flex items-center">
                                            {c.name}
                                            {c.is_blacklisted && <span className="ml-2 bg-red-100 text-red-600 text-[10px] px-1.5 rounded font-bold">é»‘åå–®</span>}
                                            {c.stats.totalRevenue > 5000 && <span className="ml-2 bg-yellow-100 text-yellow-700 text-[10px] px-1.5 rounded font-bold border border-yellow-200">VVIP</span>}
                                        </div>
                                        <div className="text-xs text-slate-500 font-mono mt-0.5 mb-1">{c.phone}</div>
                                        <div className="text-xs text-slate-400 flex items-center space-x-3">
                                            <span className="flex items-center"><Icon name="calendar" size={12} className="mr-1"/> {c.stats.totalCount} æ¬¡é ç´„</span>
                                            <span className="flex items-center text-emerald-600"><Icon name="check-circle" size={12} className="mr-1"/> {c.stats.completedCount} æ¬¡å®Œæˆ</span>
                                        </div>
                                    </div>
                                </div>
                                <div className="text-right">
                                    <div className="text-emerald-600 font-black text-xl">${c.stats.totalRevenue.toLocaleString()}</div>
                                    <div className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">ç¸½æ¶ˆè²»</div>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* â˜… å®¢æˆ¶è©³æƒ…å½ˆçª— (History Modal) */}
                    {selectedCustomer && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md animate-fade-in-up flex flex-col max-h-[85vh]">
                                <div className="p-5 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl">
                                    <div>
                                        <h3 className="text-lg font-bold text-slate-800 flex items-center">{selectedCustomer.name} çš„æ­·å²é ç´„</h3>
                                        <p className="text-xs text-slate-400 mt-0.5">{selectedCustomer.phone}</p>
                                    </div>
                                    <button onClick={()=>setSelectedCustomer(null)} className="text-slate-400 hover:text-slate-600 p-2 bg-white rounded-full shadow-sm"><Icon name="x" size={20}/></button>
                                </div>
                                
                                <div className="p-0 overflow-y-auto custom-scrollbar bg-slate-50 flex-1">
                                    {selectedCustomer.history.length === 0 ? <div className="text-center p-10 text-slate-400">ç„¡é ç´„ç´€éŒ„</div> :
                                     selectedCustomer.history.map(h => (
                                        <div key={h.id} className="bg-white p-4 border-b border-slate-100 last:border-0 flex justify-between items-center">
                                            <div>
                                                <div className="font-bold text-slate-800 text-sm mb-1">{h.service_name}</div>
                                                <div className="text-xs text-slate-400 flex items-center">
                                                    <span className="mr-2 font-mono bg-slate-100 px-1.5 rounded">{h.booking_date} {h.booking_time}</span>
                                                    <span>{h.staff_name}</span>
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <div className="font-bold text-slate-700 text-sm">${h.price}</div>
                                                <div className="mt-1">
                                                    {h.status === 'completed' && <span className="bg-emerald-100 text-emerald-700 text-[10px] px-2 py-0.5 rounded-full font-bold">å·²å®Œæˆ</span>}
                                                    {h.status === 'confirmed' && <span className="bg-blue-50 text-blue-600 text-[10px] px-2 py-0.5 rounded-full font-bold">é ç´„ä¸­</span>}
                                                    {h.status === 'cancelled' && <span className="bg-slate-100 text-slate-400 text-[10px] px-2 py-0.5 rounded-full font-bold">å·²å–æ¶ˆ</span>}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <div className="p-4 border-t bg-white rounded-b-2xl">
                                    <button onClick={()=>supabaseClient.from('customers').update({is_blacklisted: !selectedCustomer.is_blacklisted}).eq('id', selectedCustomer.id).then(()=>{ alert("ç‹€æ…‹å·²æ›´æ–°"); fetchCustomerData(); setSelectedCustomer(null); })} className={`w-full py-3 rounded-xl font-bold border transition ${selectedCustomer.is_blacklisted ? 'bg-emerald-50 text-emerald-600 border-emerald-200' : 'bg-white text-red-500 border-red-100 hover:bg-red-50'}`}>
                                        {selectedCustomer.is_blacklisted ? 'ğŸ”“ è§£é™¤é»‘åå–®' : 'ğŸ”’ è¨­å®šç‚ºé»‘åå–®'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- 4. èª²ç¨‹ç®¡ç† (Services) ---
        function ServiceManager({ supabase, storeId }) {
            const [services, setServices] = useState([]);
            const [isEditing, setIsEditing] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [form, setForm] = useState({});

            useEffect(() => { fetchServices(); }, [storeId]);
            
            async function fetchServices() {
                const { data, error } = await supabase.from('services').select('*').eq('store_id', storeId).is('deleted_at', null);
                if (error) { console.error("Read Services Error:", error); alert("è®€å–å¤±æ•—: " + error.message); }
                if (data) setServices(data);
            }

            async function handleSave() {
                const action = form.id ? 'update' : 'create';
                const price = parseInt(form.price) || 0;
                const duration = parseInt(form.duration) || 60;
                
                setIsSaving(true);
                try {
                    const { error } = await supabase.rpc('owner_manage_service', {
                        p_action: action, p_store_id: storeId, p_service_id: form.id,
                        p_name: form.name || 'æœªå‘½åèª²ç¨‹', p_price: price, 
                        p_duration: duration, p_description: form.description || ''
                    });
                    if (error) throw error;
                    alert("âœ… èª²ç¨‹å„²å­˜æˆåŠŸï¼");
                    setIsEditing(false); fetchServices(); 
                } catch (err) { alert("å„²å­˜å¤±æ•—: " + err.message); } finally { setIsSaving(false); }
            }

            async function handleDelete(id) {
                if (!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
                const { error } = await supabase.rpc('owner_manage_service', { p_action: 'delete', p_store_id: storeId, p_service_id: id });
                if (error) alert("éŒ¯èª¤: " + error.message); else { alert("åˆªé™¤æˆåŠŸï¼"); fetchServices(); }
            }

            return (
                <div className="p-4 pb-24 space-y-4 animate-fade-in-up">
                    <button onClick={()=>{setForm({name:'', price:1000, duration:60, description:''}); setIsEditing(true)}} className="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold flex items-center justify-center"><Icon name="plus" className="mr-2"/> æ–°å¢èª²ç¨‹</button>
                    {isEditing && <div className="bg-slate-50 p-4 rounded-xl border border-emerald-200 space-y-3">
                        <div>
                            <label className="block text-xs font-bold text-slate-500 mb-1">èª²ç¨‹åç¨±</label>
                            <input className="w-full p-3 border rounded-xl" placeholder="ä¾‹å¦‚ï¼šåŸºç¤ç‘œçˆ" value={form.name || ''} onChange={e=>setForm({...form, name:e.target.value})}/>
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-slate-500 mb-1">èª²ç¨‹æè¿°</label>
                            <textarea className="w-full p-3 border rounded-xl" rows="2" placeholder="ç°¡å–®ä»‹ç´¹èª²ç¨‹å…§å®¹..." value={form.description || ''} onChange={e=>setForm({...form, description:e.target.value})}></textarea>
                        </div>
                        <div className="flex gap-3">
                            <div className="flex-1"><label className="block text-xs font-bold text-slate-500 mb-1">åƒ¹æ ¼ (NT$)</label><input type="number" className="w-full p-3 border rounded-xl" placeholder="1000" value={form.price || ''} onChange={e=>setForm({...form, price:e.target.value})}/></div>
                            <div className="flex-1"><label className="block text-xs font-bold text-slate-500 mb-1">æ™‚é•· (åˆ†é˜)</label><input type="number" className="w-full p-3 border rounded-xl" placeholder="60" value={form.duration || ''} onChange={e=>setForm({...form, duration:e.target.value})}/></div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={()=>setIsEditing(false)} disabled={isSaving} className="flex-1 py-3 bg-white border rounded-xl">å–æ¶ˆ</button>
                            <button onClick={handleSave} disabled={isSaving} className="flex-1 py-3 bg-emerald-600 text-white rounded-xl">{isSaving ? "å„²å­˜ä¸­..." : "å„²å­˜"}</button>
                        </div>
                    </div>}
                    <div className="space-y-3">{services.map(s => <MobileCard key={s.id} title={s.name} subtitle={`${s.duration} åˆ†é˜`} status={<span className="font-mono text-emerald-600 font-bold">${s.price}</span>} actions={<><button onClick={()=>{setForm(s); setIsEditing(true)}} className="text-blue-500 px-3">ç·¨è¼¯</button><button onClick={()=>handleDelete(s.id)} className="text-red-500 px-3">åˆªé™¤</button></>}>
                        <div className="text-xs text-slate-400 mt-1">{s.description}</div>
                    </MobileCard>)}</div>
                </div>
            );
        }

        // --- 5. äººå“¡ç®¡ç† (Staff) ---
        function StaffManager({ supabase, storeId }) {
            const [staff, setStaff] = useState([]);
            const [isEditing, setIsEditing] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [form, setForm] = useState({});
            const fileInputRef = useRef(null);

            useEffect(() => { fetchStaff(); }, [storeId]);
            async function fetchStaff() {
                const { data, error } = await supabase.from('staff').select('*').eq('store_id', storeId).is('deleted_at', null);
                if (error) alert("è®€å–å¤±æ•—: " + error.message);
                if (data) setStaff(data);
            }

            async function handleSave() {
                const action = form.id ? 'update' : 'create';
                const avatar = form.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${form.name}`;
                setIsSaving(true);
                try {
                    const { error } = await supabase.rpc('owner_manage_staff', {
                        p_action: action, p_store_id: storeId, p_staff_id: form.id,
                        p_name: form.name || 'æœªå‘½åäººå“¡', p_title: form.title || '', 
                        p_avatar: avatar, p_login_code: form.login_code || '0000'
                    });
                    if (error) throw error;
                    alert("âœ… äººå“¡å„²å­˜æˆåŠŸï¼");
                    setIsEditing(false); fetchStaff();
                } catch(err) { alert("å„²å­˜éŒ¯èª¤: " + err.message); } finally { setIsSaving(false); }
            }

            async function handleDelete(id) {
                if (!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
                const { error } = await supabase.rpc('owner_manage_staff', { p_action: 'delete', p_store_id: storeId, p_staff_id: id });
                if (error) alert("éŒ¯èª¤: " + error.message); else { alert("åˆªé™¤æˆåŠŸï¼"); fetchStaff(); }
            }

            async function handleFileUpload(e) {
                const file = e.target.files[0];
                if (!file) return;
                try {
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;
                    const { error } = await supabase.storage.from('avatars').upload(fileName, file);
                    if (error) throw error;
                    const { data } = supabase.storage.from('avatars').getPublicUrl(fileName);
                    setForm({ ...form, avatar: data.publicUrl });
                } catch (err) {
                    console.error("Upload Error:", err);
                    alert(`ä¸Šå‚³å¤±æ•—: ${err.message}\n(æç¤º: è«‹ç¢ºä¿ Storage Bucket 'avatars' å­˜åœ¨ï¼Œä¸” Policies å…è¨± authenticated è§’è‰²å¯«å…¥)`);
                }
            }

            const copyStaffLink = (id) => {
                const link = new URL(`staff.html?id=${id}`, window.location.href).href;
                navigator.clipboard.writeText(link);
                alert("å·²è¤‡è£½äººå“¡å°ˆå±¬é€£çµï¼\n" + link);
            };

            return (
                <div className="p-4 pb-24 space-y-4 animate-fade-in-up">
                    <button onClick={()=>{setForm({name:'', title:'', login_code:'0000'}); setIsEditing(true)}} className="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold flex items-center justify-center"><Icon name="plus" className="mr-2"/> æ–°å¢äººå“¡</button>
                    {isEditing && (
                        <div className="bg-slate-50 p-6 rounded-xl border border-emerald-200 shadow-inner">
                            <h4 className="font-bold text-lg text-emerald-800 mb-4">{form.id ? 'ç·¨è¼¯äººå“¡' : 'æ–°å¢äººå“¡'}</h4>
                            <div className="flex flex-col md:flex-row gap-6">
                                <div className="flex flex-col items-center">
                                    <div className="w-24 h-24 rounded-full bg-gray-200 overflow-hidden mb-2 border-4 border-white shadow-sm relative group cursor-pointer" onClick={()=>fileInputRef.current.click()}>
                                        <img src={form.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${form.name || 'default'}`} className="w-full h-full object-cover" />
                                        <div className="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><Icon name="camera" className="text-white"/></div>
                                    </div>
                                    <button onClick={() => fileInputRef.current.click()} className="text-xs bg-slate-200 hover:bg-slate-300 px-3 py-1.5 rounded font-bold text-slate-600 transition">ä¸Šå‚³ç…§ç‰‡</button>
                                    <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleFileUpload} />
                                </div>
                                <div className="flex-1 space-y-3">
                                    <div><label className="text-xs text-slate-500 font-bold">å§“å</label><input className="w-full p-3 border rounded-xl" value={form.name || ''} onChange={e=>setForm({...form, name:e.target.value})} /></div>
                                    <div><label className="text-xs text-slate-500 font-bold">è·ç¨±</label><input className="w-full p-3 border rounded-xl" value={form.title || ''} onChange={e=>setForm({...form, title:e.target.value})} /></div>
                                    <div><label className="text-xs text-slate-500 font-bold">ç™»å…¥ç¢¼ (Passcode)</label><input className="w-full p-3 border rounded-xl font-mono text-emerald-600 font-bold" value={form.login_code || ''} onChange={e=>setForm({...form, login_code:e.target.value})} /></div>
                                </div>
                            </div>
                            <div className="flex gap-2 mt-6 pt-4 border-t border-slate-200">
                                <button onClick={() => setIsEditing(false)} disabled={isSaving} className="flex-1 py-3 text-slate-500 bg-white rounded-xl font-bold border hover:bg-slate-50 transition">å–æ¶ˆ</button>
                                <button onClick={handleSave} disabled={isSaving} className="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-700 transition">{isSaving ? "å„²å­˜ä¸­..." : "å„²å­˜è³‡æ–™"}</button>
                            </div>
                        </div>
                    )}
                    <div className="space-y-3">{staff.map(s => (
                        <div key={s.id} className="bg-white p-4 rounded-xl border flex items-center shadow-sm">
                            <img src={s.avatar} className="w-12 h-12 rounded-full mr-3 bg-slate-200 flex-shrink-0 object-cover"/>
                            <div className="flex-1 min-w-0">
                                <div className="font-bold text-slate-800">{s.name}</div>
                                <div className="text-xs text-slate-500">{s.title} | Code: <span className="font-mono bg-slate-100 px-1 rounded">{s.login_code}</span></div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={()=>copyStaffLink(s.id)} className="p-2 text-emerald-500 hover:bg-emerald-50 rounded-lg" title="è¤‡è£½é€£çµ"><Icon name="link" size={18}/></button>
                                <button onClick={()=>{setForm(s); setIsEditing(true)}} className="p-2 text-blue-500 hover:bg-blue-50 rounded-lg"><Icon name="edit" size={18}/></button>
                                <button onClick={()=>handleDelete(s.id)} className="p-2 text-red-500 hover:bg-red-50 rounded-lg"><Icon name="trash-2" size={18}/></button>
                            </div>
                        </div>
                    ))}</div>
                </div>
            );
        }

        // --- 6. å•†åº—è¨­å®š (Settings) ---
        function SettingsManager({ supabase, storeId }) {
            const [store, setStore] = useState({});
            const [link, setLink] = useState('');
            useEffect(() => { supabase.from('stores').select('*').eq('id', storeId).single().then(({data}) => setStore(data || {})); setLink(new URL(`booking.html?id=${storeId}`, window.location.href).href); }, [storeId]);
            const handleSave = async () => { await supabase.from('stores').update(store).eq('id', storeId); alert("âœ… è¨­å®šå·²å„²å­˜"); };
            const timeOptions = []; for(let h=0; h<24; h++) { timeOptions.push(`${String(h).padStart(2,'0')}:00`); timeOptions.push(`${String(h).padStart(2,'0')}:30`); }

            // â˜… æ–°å¢ï¼šå¸¶å…¥ç¯„æœ¬åŠŸèƒ½
            const applyTemplate = () => {
                if (store.terms && !confirm("ç¢ºå®šè¦è¦†è“‹ç›®å‰çš„é ç´„é ˆçŸ¥å—ï¼Ÿ")) return;
                const template = `ã€é ç´„é ˆçŸ¥ã€‘
1. è«‹æå‰ 5-10 åˆ†é˜æŠµé”ï¼Œä»¥ä¾¿æ›´æ›è¡£ç‰©èˆ‡æº–å‚™ã€‚
2. è‹¥éœ€å–æ¶ˆæˆ–æ”¹æœŸï¼Œè«‹æ–¼é ç´„æ™‚é–“å‰ 24 å°æ™‚é€šçŸ¥ï¼Œä»¥å…å½±éŸ¿æ‚¨çš„æ¬Šç›Šã€‚
3. è«‹ç©¿è‘—èˆ’é©ã€å¥½æ´»å‹•çš„é‹å‹•æœè£ã€‚
4. åˆæ¬¡é«”é©—è«‹æ”œå¸¶èº«åˆ†è­‰ä»¶ä»¥ä¾›æ ¸å°ã€‚
5. ç¾å ´æä¾›é£²æ°´ï¼Œè«‹è‡ªå‚™ç’°ä¿æ¯ã€‚

æœŸå¾…æ‚¨çš„å…‰è‡¨ï¼`;
                setStore({ ...store, terms: template });
            };

            return (
                <div className="p-4 pb-24 md:p-6 bg-white md:rounded-2xl shadow-sm md:border border-slate-100 space-y-6 animate-fade-in-up">
                    <div className="space-y-4">
                        <input className="w-full p-3 border rounded-xl font-bold" placeholder="åº—å" value={store.name||''} onChange={e=>setStore({...store, name:e.target.value})}/>
                        <input className="w-full p-3 border rounded-xl" placeholder="åœ°å€" value={store.address||''} onChange={e=>setStore({...store, address:e.target.value})}/>
                        <div>
                            <label className="block text-xs font-bold text-slate-500 mb-1">å•†åº—ç°¡ä»‹</label>
                            <textarea className="w-full p-3 border rounded-xl" rows="3" placeholder="ä»‹ç´¹æ‚¨çš„å·¥ä½œå®¤..." value={store.description||''} onChange={e=>setStore({...store, description:e.target.value})}></textarea>
                        </div>
                        <div>
                            {/* â˜… æ›´æ–°ï¼šç¯„æœ¬æŒ‰éˆ• */}
                            <div className="flex justify-between items-end mb-1">
                                <label className="block text-xs font-bold text-slate-500">é ç´„é ˆçŸ¥ / æ³¨æ„äº‹é …</label>
                                <button onClick={applyTemplate} className="text-[10px] text-blue-500 hover:text-blue-700 bg-blue-50 px-2 py-1 rounded font-bold transition">ğŸ“ å¸¶å…¥ç¯„æœ¬</button>
                            </div>
                            <textarea className="w-full p-3 border rounded-xl" rows="3" placeholder="ä¾‹å¦‚ï¼šè«‹æå‰ 10 åˆ†é˜æŠµé”ã€å–æ¶ˆè«‹æ–¼ 24 å°æ™‚å‰é€šçŸ¥..." value={store.terms||''} onChange={e=>setStore({...store, terms:e.target.value})}></textarea>
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                            <select className="w-full p-3 border rounded-xl bg-white" value={store.open_time||'09:00'} onChange={e=>setStore({...store, open_time:e.target.value})}>{timeOptions.map(t=><option key={t} value={t}>{t}</option>)}</select>
                            <select className="w-full p-3 border rounded-xl bg-white" value={store.close_time||'21:00'} onChange={e=>setStore({...store, close_time:e.target.value})}>{timeOptions.map(t=><option key={t} value={t}>{t}</option>)}</select>
                        </div>
                        <div><label className="text-xs text-slate-500 font-bold ml-1">é ç´„ç·©è¡ (å°æ™‚)</label><input type="number" className="w-full p-3 border rounded-xl" value={store.min_lead_hours||0} onChange={e=>setStore({...store, min_lead_hours:parseInt(e.target.value)||0})}/></div>
                        <button onClick={handleSave} className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold text-lg shadow-lg active:scale-95">å„²å­˜è¨­å®š</button>
                    </div>
                </div>
            );
        }

        // --- ä¸»ç¨‹å¼æ¶æ§‹ ---
        function AdminApp() {
            const [store, setStore] = useState(null);
            const [login, setLogin] = useState({email:'', password:''});
            const [view, setView] = useState('dashboard');
            const [loading, setLoading] = useState(false);
            const [showMenu, setShowMenu] = useState(false);

            useEffect(() => { supabaseClient.auth.getSession().then(({data:{session}})=>{ if(session) fetchStore(session.user.id); }); }, []);
            async function fetchStore(uid) { const {data} = await supabaseClient.from('stores').select('*').eq('owner_id', uid).single(); if(data) setStore(data); }
            async function handleLogin() { setLoading(true); const {data, error} = await supabaseClient.auth.signInWithPassword(login); if(error) alert("ç™»å…¥å¤±æ•—"); else if(data.user) fetchStore(data.user.id); setLoading(false); }

            const copyShopLink = () => {
                if(!store) return;
                const link = new URL(`booking.html?id=${store.id}`, window.location.href).href;
                navigator.clipboard.writeText(link);
                alert("å·²è¤‡è£½é ç´„é€£çµï¼\n" + link);
            };

            if (!store) return <div className="min-h-screen flex items-center justify-center p-6 bg-slate-100"><div className="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm text-center"><h2 className="text-2xl font-bold mb-6">å•†å®¶ç™»å…¥</h2><input className="w-full p-4 border rounded-xl mb-3" placeholder="Email" value={login.email} onChange={e=>setLogin({...login, email:e.target.value})}/><input type="password" className="w-full p-4 border rounded-xl mb-6" placeholder="Password" value={login.password} onChange={e=>setLogin({...login, password:e.target.value})}/><button onClick={handleLogin} disabled={loading} className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold">{loading?"...":"ç™»å…¥"}</button></div></div>;

            const NavItem = ({id, icon, label}) => <button onClick={()=>{setView(id); setShowMenu(false)}} className={`flex items-center w-full p-4 font-bold rounded-xl mb-1 ${view===id?'bg-emerald-50 text-emerald-600':'text-slate-500 hover:bg-slate-50'}`}><Icon name={icon} className="mr-3"/> {label}</button>;

            return (
                <div className="min-h-screen flex flex-col md:flex-row bg-slate-50">
                    <header className="md:hidden bg-white p-4 flex justify-between items-center shadow-sm sticky top-0 z-20"><div className="font-bold text-lg">ğŸ§˜â€â™€ï¸ {store.name}</div><button onClick={()=>setShowMenu(!showMenu)} className="p-2 bg-slate-100 rounded"><Icon name="menu"/></button></header>
                    {showMenu && <div className="fixed inset-0 bg-black/50 z-30 md:hidden" onClick={()=>setShowMenu(false)}></div>}
                    <aside className={`fixed inset-y-0 left-0 w-64 bg-white border-r z-40 transform transition-transform md:translate-x-0 md:static ${showMenu?'translate-x-0':'-translate-x-full'} flex flex-col`}>
                        <div className="p-6 border-b hidden md:block">
                            <h1 className="text-xl font-bold">EasyBook</h1>
                            <p className="text-xs text-slate-400 mt-1 truncate">{store.name}</p>
                            <button onClick={copyShopLink} className="mt-3 w-full bg-emerald-50 text-emerald-600 text-xs font-bold py-2 rounded-lg flex items-center justify-center hover:bg-emerald-100 transition"><Icon name="link" size={14} className="mr-1"/> è¤‡è£½é ç´„é€£çµ</button>
                        </div>
                        <nav className="p-4 flex-1 overflow-y-auto">
                            <NavItem id="dashboard" icon="layout-dashboard" label="å„€è¡¨æ¿"/>
                            <NavItem id="schedule" icon="calendar-clock" label="æ’ç­/å…¬ä¼‘"/>
                            <NavItem id="customers" icon="users" label="å®¢æˆ¶ç®¡ç†"/>
                            <NavItem id="services" icon="list" label="èª²ç¨‹ç®¡ç†"/>
                            <NavItem id="staff" icon="user-check" label="äººå“¡ç®¡ç†"/>
                            <NavItem id="settings" icon="settings" label="å•†åº—è¨­å®š"/>
                        </nav>
                        <div className="p-4 border-t border-slate-100">
                            <button onClick={() => supabaseClient.auth.signOut().then(() => setStore(null))} className="flex items-center text-slate-400 hover:text-red-500 w-full p-2 font-bold"><Icon name="log-out" className="mr-2"/> ç™»å‡º</button>
                        </div>
                    </aside>
                    <main className="flex-1 p-4 md:p-8 overflow-y-auto max-w-6xl mx-auto w-full h-[calc(100vh-64px)] md:h-screen">
                        {view === 'dashboard' && <DashboardView supabase={supabaseClient} storeId={store.id} />}
                        {view === 'schedule' && <ScheduleManager supabase={supabaseClient} storeId={store.id} />}
                        {view === 'customers' && <CustomerManager supabase={supabaseClient} storeId={store.id} />}
                        {view === 'services' && <ServiceManager supabase={supabaseClient} storeId={store.id} />}
                        {view === 'staff' && <StaffManager supabase={supabaseClient} storeId={store.id} />}
                        {view === 'settings' && <SettingsManager supabase={supabaseClient} storeId={store.id} />}
                    </main>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AdminApp />);
    </script>
</body>
</html>