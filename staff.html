<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EasyBook è€å¸«å°ˆå€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- QRCode ç”¢ç”Ÿå™¨ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 2px; }
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // â˜… Supabase è¨­å®š
        const supabaseUrl = 'https://kwvbhzjzysmivafsvwng.supabase.co';
        const supabaseKey = 'sb_publishable_7RUbenk2kXNDmvuo1XtHbQ_m0RjXuZr'; 
        const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

        const Icon = ({ name, size = 20, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && window.lucide) {
                    ref.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    i.setAttribute('width', size);
                    i.setAttribute('height', size);
                    if (className) i.setAttribute('class', className);
                    ref.current.appendChild(i);
                    window.lucide.createIcons({ root: ref.current });
                }
            }, [name, size, className]);
            return <span ref={ref} className="inline-flex items-center justify-center"></span>;
        };

        // --- å­çµ„ä»¶ï¼šQR Code é¡¯ç¤ºå™¨ (å½ˆçª—ç”¨) ---
        function QRCodeViewer({ link }) {
            const qrRef = useRef(null);
            useEffect(() => {
                if (qrRef.current) {
                    qrRef.current.innerHTML = "";
                    new QRCode(qrRef.current, {
                        text: link,
                        width: 200,
                        height: 200,
                        colorDark : "#0f172a",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                }
            }, [link]);
            return <div ref={qrRef} className="p-4 bg-white border border-slate-200 rounded-2xl inline-block"></div>;
        }

        // --- å­çµ„ä»¶ï¼šæœˆæ›†è¦–åœ– (Calendar View) ---
        function CalendarView({ bookings, currentDate, onDateChange, onDayClick }) {
            const year = parseInt(currentDate.split('-')[0]);
            const month = parseInt(currentDate.split('-')[1]) - 1;

            const getDaysInMonth = (y, m) => new Date(y, m + 1, 0).getDate();
            const getFirstDayOfMonth = (y, m) => new Date(y, m, 1).getDay();

            const daysInMonth = getDaysInMonth(year, month);
            const firstDay = getFirstDayOfMonth(year, month);

            const days = [];
            for (let i = 0; i < firstDay; i++) days.push(<div key={`empty-${i}`} className="h-20 bg-slate-50 border border-slate-100"></div>);
            
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const dayBookings = bookings.filter(b => b.booking_date === dateStr && b.status !== 'cancelled');
                const isBlocked = dayBookings.some(b => b.status === 'blocked');
                const hasOrder = dayBookings.some(b => b.status === 'confirmed' || b.status === 'completed');
                const orderCount = dayBookings.filter(b=>b.status!=='blocked').length;

                days.push(
                    <div key={d} onClick={() => onDayClick(dateStr, dayBookings)} className={`h-20 border border-slate-100 p-1 relative active:scale-95 transition cursor-pointer ${isBlocked ? 'bg-red-50/50' : 'bg-white hover:bg-slate-50'}`}>
                        <span className="text-xs font-bold text-slate-400">{d}</span>
                        <div className="mt-1 flex flex-col gap-1 items-center">
                            {isBlocked && <span className="text-[9px] bg-red-100 text-red-600 px-1.5 py-0.5 rounded-full font-bold">ä¼‘</span>}
                            {hasOrder && <span className="text-[9px] bg-emerald-100 text-emerald-600 px-1.5 py-0.5 rounded-full font-bold">{orderCount} èª²</span>}
                        </div>
                    </div>
                );
            }

            const handleMonthChange = (delta) => {
                const newDate = new Date(year, month + delta, 1);
                const newStr = `${newDate.getFullYear()}-${String(newDate.getMonth()+1).padStart(2,'0')}-01`;
                onDateChange(newStr);
            };

            return (
                <div className="animate-fade-in-up pb-24">
                    <div className="flex justify-between items-center mb-4 bg-white p-3 rounded-2xl shadow-sm">
                        <button onClick={() => handleMonthChange(-1)} className="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-full"><Icon name="chevron-left"/></button>
                        <span className="font-bold text-lg text-slate-700">{year}å¹´ {month+1}æœˆ</span>
                        <button onClick={() => handleMonthChange(1)} className="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-full"><Icon name="chevron-right"/></button>
                    </div>
                    <div className="grid grid-cols-7 gap-px bg-slate-200 border border-slate-200 rounded-2xl overflow-hidden text-center shadow-sm">
                        {['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d => <div key={d} className="bg-slate-100 p-2 text-xs font-bold text-slate-500">{d}</div>)}
                        {days}
                    </div>
                    <p className="text-center text-xs text-slate-400 mt-4">é»æ“Šæ—¥æœŸå¯æŸ¥çœ‹ç•¶æ—¥è©³æƒ…</p>
                </div>
            );
        }

        // --- â˜… å‡ç´šç‰ˆï¼šå®¢æˆ¶åˆ—è¡¨èˆ‡ç®¡ç† (Clients View) ---
        function ClientsView({ storeId, loginCode, supabase }) {
            const [clients, setClients] = useState([]);
            const [loading, setLoading] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [editingClient, setEditingClient] = useState(null);
            const [note, setNote] = useState('');

            useEffect(() => {
                fetchClients();
            }, [storeId]);

            async function fetchClients() {
                setLoading(true);
                try {
                    // 1. å–å¾—å®¢æˆ¶è³‡æ–™ (å«å‚™è¨»)
                    const { data: rawClients, error } = await supabase.rpc('staff_get_store_customers', {
                        p_store_id: storeId,
                        p_staff_code: loginCode 
                    });
                    if (error) throw error;

                    // 2. å–å¾—è¨‚å–®èˆ‡èª²ç¨‹ (ç‚ºäº†è¨ˆç®—é‡‘é¡èˆ‡å ‚æ•¸)
                    // æ³¨æ„ï¼šéœ€ç¢ºä¿è€å¸«æœ‰æ¬Šé™è®€å–åº—å…§è¨‚å–®ï¼Œè‹¥ RLS æ“‹ä½å‰‡æ•¸å­—æœƒæ˜¯ 0
                    const [bookRes, servRes] = await Promise.all([
                        supabase.from('bookings').select('*').eq('store_id', storeId),
                        supabase.from('services').select('name, price').eq('store_id', storeId)
                    ]);

                    const allBookings = bookRes.data || [];
                    const services = servRes.data || [];
                    const priceMap = {};
                    services.forEach(s => priceMap[s.name] = s.price);

                    // 3. èšåˆæ•¸æ“š
                    const processed = (rawClients || []).map(c => {
                        const myBookings = allBookings.filter(b => b.customer_phone === c.phone); // ç”¨é›»è©±åŒ¹é…æœ€æº–
                        let completedCount = 0;
                        let totalRevenue = 0;
                        
                        myBookings.forEach(b => {
                            if (b.status === 'completed' || b.status === 'confirmed') {
                                const price = priceMap[b.service_name] || 0;
                                if (b.status === 'completed') {
                                    completedCount++;
                                    totalRevenue += price;
                                }
                            }
                        });

                        return { ...c, totalRevenue, completedCount };
                    });

                    // ä¾é‡‘é¡æ’åº (é«˜åƒ¹å€¼å„ªå…ˆ)
                    processed.sort((a, b) => b.totalRevenue - a.totalRevenue);
                    setClients(processed);

                } catch (err) {
                    console.error("Fetch Clients Error:", err);
                    alert("ç„¡æ³•è®€å–å®¢æˆ¶åˆ—è¡¨: " + err.message);
                } finally {
                    setLoading(false);
                }
            }

            async function handleSave() {
                if (!editingClient) return;
                try {
                    const { error } = await supabase.rpc('staff_update_customer_note', {
                        p_customer_id: editingClient.id,
                        p_note: note,
                        p_staff_code: loginCode
                    });
                    if (error) throw error;
                    
                    // è‹¥éœ€è¦æ›´æ–°é»‘åå–® (ç›®å‰ RPC æ²’åŒ…å«é»‘åå–®æ›´æ–°ï¼Œé€™è£¡ç¤ºç¯„è‹¥æœ‰ update æ¬Šé™)
                    // const { error: blError } = await supabase.from('customers').update({ is_blacklisted: editingClient.is_blacklisted }).eq('id', editingClient.id);
                    
                    alert("âœ… è³‡æ–™å·²æ›´æ–°");
                    setEditingClient(null);
                    fetchClients(); // Refresh
                } catch (err) {
                    alert("æ›´æ–°å¤±æ•—: " + err.message);
                }
            }
            
            // é»‘åå–®åˆ‡æ› (éœ€æ­é… SQL update æ¬Šé™ï¼Œæˆ–æ“´å…… RPC)
            async function toggleBlacklist() {
               setEditingClient(prev => ({...prev, is_blacklisted: !prev.is_blacklisted}));
               // é€™è£¡åƒ…æ›´æ–° UI ç‹€æ…‹ï¼Œå¯¦éš›å¯«å…¥åœ¨ handleSave æˆ–éœ€è¦ç¨ç«‹ RPC
               // ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘å‡è¨­è€å¸«ç›®å‰åªèƒ½æ”¹å‚™è¨»ã€‚è‹¥è¦æ”¹é»‘åå–®ï¼Œå»ºè­°æ“´å…… RPCã€‚
               // æš«æ™‚é€é alert æç¤º
               alert("æé†’ï¼šç›®å‰åƒ…åº—é•·å¯ä¿®æ”¹é»‘åå–®ç‹€æ…‹ (æ¬Šé™ç®¡åˆ¶ä¸­)");
            }

            const filtered = clients.filter(c => 
                (c.name && c.name.includes(searchTerm)) || 
                (c.phone && c.phone.includes(searchTerm))
            );

            return (
                <div className="animate-fade-in-up pb-20">
                    {/* æœå°‹æ¬„ */}
                    <div className="mb-4 relative">
                        <input type="text" placeholder="æœå°‹å§“åæˆ–é›»è©±..." className="pl-10 pr-4 py-3 border rounded-xl text-sm bg-white w-full focus:ring-2 focus:ring-emerald-500 outline-none shadow-sm" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                        <Icon name="search" size={18} className="absolute left-3 top-3.5 text-slate-400"/>
                    </div>

                    {/* å®¢æˆ¶åˆ—è¡¨ (å„ªåŒ–ç‰ˆ UI) */}
                    <div className="space-y-3">
                        {loading ? <div className="text-center p-8 text-slate-400">è¼‰å…¥ä¸­...</div> : 
                         filtered.length === 0 ? <div className="text-center p-8 text-slate-400">ç„¡ç›¸é—œå®¢æˆ¶</div> :
                         filtered.map(c => (
                            <div key={c.id} onClick={()=>{setEditingClient(c); setNote(c.notes || '');}} className={`bg-white p-4 rounded-xl border shadow-sm flex items-center justify-between cursor-pointer active:scale-95 transition ${c.is_blacklisted ? 'border-red-200 bg-red-50/30' : 'border-slate-100 hover:border-emerald-300'}`}>
                                {/* å·¦ï¼šè­˜åˆ¥å€ */}
                                <div className="flex items-center">
                                    <div className="relative mr-4">
                                        <div className={`w-12 h-12 rounded-full overflow-hidden border-2 ${c.is_blacklisted ? 'border-red-400 opacity-60' : 'border-slate-200'}`}>
                                            {c.avatar_url ? <img src={c.avatar_url} className="w-full h-full object-cover"/> : <div className="flex items-center justify-center h-full bg-slate-100 text-slate-300"><Icon name="user" size={20}/></div>}
                                        </div>
                                        {c.is_blacklisted && <div className="absolute -bottom-1 -right-1 bg-red-500 text-white rounded-full p-0.5 border-2 border-white"><Icon name="x" size={12}/></div>}
                                    </div>
                                    <div>
                                        <div className="font-bold text-slate-800 text-base flex items-center">
                                            {c.name}
                                            {/* å‚™è¨»æç¤ºåœ–ç¤º */}
                                            {c.notes && <Icon name="file-text" size={14} className="ml-1.5 text-blue-400"/>}
                                        </div>
                                        <div className="text-xs text-slate-400 font-mono mt-0.5">{c.phone}</div>
                                    </div>
                                </div>

                                {/* å³ï¼šåƒ¹å€¼å€ */}
                                <div className="text-right">
                                    <div className="text-emerald-600 font-black text-lg">${c.totalRevenue.toLocaleString()}</div>
                                    <div className="text-[10px] text-slate-400 font-bold bg-slate-100 px-1.5 py-0.5 rounded inline-block">{c.completedCount} å ‚</div>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* è©³æƒ…å½ˆçª— (Detail Modal) */}
                    {editingClient && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm" onClick={()=>setEditingClient(null)}>
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm animate-fade-in-up flex flex-col overflow-hidden" onClick={e=>e.stopPropagation()}>
                                {/* Header Info */}
                                <div className="p-6 bg-slate-50 border-b flex items-center">
                                    <div className="w-16 h-16 rounded-full bg-white border-2 border-white shadow-md mr-4 overflow-hidden">
                                        {editingClient.avatar_url ? <img src={editingClient.avatar_url} className="w-full h-full object-cover"/> : <div className="w-full h-full flex items-center justify-center bg-slate-100 text-slate-300"><Icon name="user" size={24}/></div>}
                                    </div>
                                    <div>
                                        <h3 className="text-xl font-bold text-slate-800">{editingClient.name}</h3>
                                        <p className="text-sm text-slate-500 font-mono">{editingClient.phone}</p>
                                        <div className="flex gap-2 mt-2">
                                            {editingClient.is_blacklisted && <span className="text-[10px] bg-red-100 text-red-600 px-2 py-0.5 rounded-full font-bold">é»‘åå–®</span>}
                                            <span className="text-[10px] bg-emerald-100 text-emerald-600 px-2 py-0.5 rounded-full font-bold">ä¸Šæ¬¡ï¼š{editingClient.last_visit || 'ç„¡'}</span>
                                        </div>
                                    </div>
                                </div>

                                {/* Stats Bar */}
                                <div className="grid grid-cols-2 border-b border-slate-100 divide-x divide-slate-100">
                                    <div className="p-3 text-center">
                                        <div className="text-[10px] text-slate-400 uppercase tracking-wider">ç´¯ç©æ¶ˆè²»</div>
                                        <div className="text-lg font-black text-emerald-600">${editingClient.totalRevenue.toLocaleString()}</div>
                                    </div>
                                    <div className="p-3 text-center">
                                        <div className="text-[10px] text-slate-400 uppercase tracking-wider">å®Œæˆèª²ç¨‹</div>
                                        <div className="text-lg font-black text-slate-700">{editingClient.completedCount} <span className="text-xs font-normal">å ‚</span></div>
                                    </div>
                                </div>
                                
                                {/* Edit Section */}
                                <div className="p-5 bg-white">
                                    <label className="block text-xs font-bold text-slate-500 mb-2 flex items-center"><Icon name="edit-3" size={14} className="mr-1"/> é€²åº¦å‚™è¨» / èº«é«”ç‹€æ³</label>
                                    <textarea className="w-full p-3 border rounded-xl h-32 text-sm focus:ring-2 focus:ring-emerald-500 outline-none bg-slate-50 resize-none" placeholder="è¼¸å…¥å‚™è¨»å…§å®¹..." value={note} onChange={e=>setNote(e.target.value)}></textarea>
                                </div>

                                {/* Footer Actions */}
                                <div className="p-4 border-t bg-slate-50 flex gap-2">
                                    <button onClick={toggleBlacklist} className={`p-3 rounded-xl border ${editingClient.is_blacklisted ? 'border-emerald-200 text-emerald-600 bg-emerald-50' : 'border-red-200 text-red-500 bg-white hover:bg-red-50'} transition`}>
                                        <Icon name={editingClient.is_blacklisted ? "unlock" : "lock"} size={20}/>
                                    </button>
                                    <button onClick={handleSave} className="flex-1 bg-slate-800 text-white rounded-xl font-bold text-sm shadow-lg hover:bg-slate-900 transition">å„²å­˜è®Šæ›´</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- å­çµ„ä»¶ï¼šä»£å®¢é ç´„ (Walk-in Booking) ---
        function WalkInBooking({ storeId, staffName, services, onBook, loading }) {
            const [form, setForm] = useState({ name: '', phone: '', date: '', time: '', service: '' });
            const [timeSlots, setTimeSlots] = useState([]);

            useEffect(() => {
                const slots = [];
                for(let h=9; h<21; h++) {
                    slots.push(`${String(h).padStart(2,'0')}:00`);
                    slots.push(`${String(h).padStart(2,'0')}:30`);
                }
                setTimeSlots(slots);
                setForm(prev => ({...prev, date: new Date().toISOString().split('T')[0], time: '10:00'}));
            }, []);

            return (
                <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm mt-4 animate-fade-in-up">
                    <h3 className="font-bold text-slate-800 mb-4 flex items-center"><Icon name="user-plus" className="mr-2 text-blue-500"/> ä»£å®¢é ç´„ (Walk-in)</h3>
                    <div className="space-y-3">
                        <div className="grid grid-cols-2 gap-3">
                            <input placeholder="å®¢æˆ¶å§“å" className="p-2 border rounded-xl bg-slate-50 text-sm" value={form.name} onChange={e=>setForm({...form, name:e.target.value})}/>
                            <input placeholder="æ‰‹æ©Ÿ (09...)" className="p-2 border rounded-xl bg-slate-50 text-sm" value={form.phone} onChange={e=>setForm({...form, phone:e.target.value})}/>
                        </div>
                        <select className="w-full p-2 border rounded-xl bg-slate-50 text-sm" value={form.service} onChange={e=>setForm({...form, service:e.target.value})}>
                            <option value="">é¸æ“‡èª²ç¨‹...</option>
                            {services.map(s => <option key={s.id} value={s.name}>{s.name} (${s.price})</option>)}
                        </select>
                        <div className="grid grid-cols-2 gap-3">
                            <input type="date" className="p-2 border rounded-xl bg-slate-50 text-sm" value={form.date} onChange={e=>setForm({...form, date:e.target.value})}/>
                            <select className="p-2 border rounded-xl bg-slate-50 text-sm" value={form.time} onChange={e=>setForm({...form, time:e.target.value})}>
                                {timeSlots.map(t => <option key={t} value={t}>{t}</option>)}
                            </select>
                        </div>
                        <button onClick={()=>onBook(form)} disabled={loading} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition">
                            {loading ? 'è™•ç†ä¸­...' : 'ç¢ºèªæ–°å¢é ç´„'}
                        </button>
                    </div>
                </div>
            );
        }

        // --- å­çµ„ä»¶ï¼šæ’ä¼‘ç”³è«‹ ---
        function LeaveRequest({ onApply, loading }) {
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [time, setTime] = useState('10:00');
            
            return (
                <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm mt-4 animate-fade-in-up">
                    <h3 className="font-bold text-slate-800 mb-4 flex items-center"><Icon name="coffee" className="mr-2 text-orange-500"/> ç”³è«‹æ’ä¼‘/é–å®šæ™‚æ®µ</h3>
                    <div className="flex gap-3 mb-3">
                        <input type="date" value={date} onChange={e=>setDate(e.target.value)} className="flex-1 p-2 border rounded-xl bg-slate-50"/>
                        <input type="time" value={time} onChange={e=>setTime(e.target.value)} className="flex-1 p-2 border rounded-xl bg-slate-50"/>
                    </div>
                    <button onClick={()=>onApply(date, time)} disabled={loading} className="w-full bg-orange-50 text-orange-600 border border-orange-200 py-3 rounded-xl font-bold hover:bg-orange-100 transition">
                        {loading ? 'è™•ç†ä¸­...' : 'é–å®šæ­¤æ™‚æ®µ'}
                    </button>
                </div>
            );
        }

        // --- ä¸»ç¨‹å¼ ---
        function StaffApp() {
            const [staffId, setStaffId] = useState(null);
            const [staffData, setStaffData] = useState(null);
            const [loginCode, setLoginCode] = useState('');
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [loading, setLoading] = useState(false);
            const [bookings, setBookings] = useState([]);
            const [services, setServices] = useState([]);
            const [view, setView] = useState('schedule');
            const [calendarDate, setCalendarDate] = useState(new Date().toISOString().split('T')[0]);
            
            const [showQRModal, setShowQRModal] = useState(false);
            const [selectedDayBookings, setSelectedDayBookings] = useState(null); 

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const id = params.get('staff_id') || params.get('id');
                if (id) {
                    setStaffId(id);
                    fetchPublicStaffInfo(id);
                }
                
                const savedSession = localStorage.getItem(`staff_session_${id}`);
                if (savedSession) {
                    setLoginCode(savedSession);
                    verifyLogin(id, savedSession);
                }
            }, []);

            async function fetchPublicStaffInfo(id) {
                const { data } = await supabaseClient.from('staff').select('id, name, avatar, title').eq('id', id).single();
                if (data) setStaffData(prev => ({...prev, ...data}));
            }

            async function verifyLogin(id, code) {
                setLoading(true);
                try {
                    const { data, error } = await supabaseClient.from('staff').select('*').eq('id', id).eq('login_code', code).single();
                    if (error || !data) throw new Error("ç™»å…¥å¤±æ•—");
                    setStaffData(data);
                    setIsLoggedIn(true);
                    localStorage.setItem(`staff_session_${id}`, code);
                    fetchData(data.id, data.store_id);
                } catch (err) {
                    if(!localStorage.getItem(`staff_session_${id}`)) alert("é©—è­‰å¤±æ•—ï¼šä»£ç¢¼éŒ¯èª¤æˆ–é€£çµç„¡æ•ˆ");
                    localStorage.removeItem(`staff_session_${id}`);
                } finally {
                    setLoading(false);
                }
            }

            async function fetchData(sId, storeId) {
                const { data: bData } = await supabaseClient.from('bookings')
                    .select('*')
                    .eq('store_id', storeId)
                    .eq('staff_name', staffData?.name || (await supabaseClient.from('staff').select('name').eq('id', sId).single()).data.name)
                    .order('booking_date', { ascending: false })
                    .order('booking_time', { ascending: true });
                if (bData) setBookings(bData);

                const { data: sData } = await supabaseClient.from('services').select('*').eq('store_id', storeId).is('deleted_at', null);
                if (sData) setServices(sData);
            }

            async function handleStatusChange(bookingIds, newStatus) {
                const ids = Array.isArray(bookingIds) ? bookingIds : [bookingIds];
                const actionName = newStatus === 'completed' ? 'å®Œæˆ' : 'å–æ¶ˆ';
                if(!confirm(`ç¢ºå®šè¦${actionName} ${ids.length} ç­†é …ç›®å—ï¼Ÿ`)) return;
                setLoading(true);
                
                let errorCount = 0;
                for (const id of ids) {
                    const { error } = await supabaseClient.rpc('staff_update_booking_status', {
                        p_booking_id: id,
                        p_new_status: newStatus,
                        p_staff_id: staffId,   
                        p_staff_code: loginCode 
                    });
                    if(error) errorCount++;
                }

                if (errorCount > 0) alert("éƒ¨åˆ†æ“ä½œå¤±æ•— (å¯èƒ½æ˜¯æ¬Šé™å•é¡Œ)");
                else alert(`${actionName}æˆåŠŸï¼`);
                fetchData(staffId, staffData.store_id);
                setLoading(false);
                setSelectedDayBookings(null); 
            }

            async function handleSelfLeave(date, time) {
                if(!confirm(`ç¢ºå®šè¦é–å®š ${date} ${time} å—ï¼Ÿ`)) return;
                setLoading(true);
                
                const conflict = bookings.find(b => b.booking_date === date && b.booking_time === time && b.status === 'confirmed');
                if(conflict) {
                    alert(`ç„¡æ³•æ’ä¼‘ï¼šè©²æ™‚æ®µå·²æœ‰é ç´„ (${conflict.customer_name})`);
                    setLoading(false);
                    return;
                }

                const { error } = await supabaseClient.rpc('staff_self_block_time', {
                    p_store_id: staffData.store_id,
                    p_staff_id: staffId,       
                    p_staff_name: staffData.name,
                    p_date: date,
                    p_time: time,
                    p_staff_code: loginCode
                });

                if (error) alert("æ’ä¼‘å¤±æ•—: " + error.message);
                else { alert("å·²é–å®šæ™‚æ®µ"); fetchData(staffId, staffData.store_id); }
                setLoading(false);
            }

            async function handleWalkIn(form) {
                if(!form.name || !form.phone || !form.service) return alert("è«‹å¡«å¯«å®Œæ•´è³‡æ–™");
                setLoading(true);
                try {
                    const { error } = await supabaseClient.rpc('public_submit_booking', {
                        p_store_id: staffData.store_id,
                        p_name: form.name,
                        p_phone: form.phone,
                        p_line_uid: null,
                        p_booking_date: form.date,
                        p_booking_time: form.time,
                        p_service_name: form.service,
                        p_staff_name: staffData.name,
                        p_device_info: "Staff Walk-in"
                    });
                    if (error) throw error;
                    alert("âœ… é ç´„æˆåŠŸï¼");
                    fetchData(staffId, staffData.store_id);
                    setView('schedule');
                } catch(err) { alert("é ç´„å¤±æ•—: " + err.message); } finally { setLoading(false); }
            }

            // --- åˆ—è¡¨æ¸²æŸ“å·¥å…· ---
            const BookingList = ({ items, emptyMsg }) => {
                 if (items.length === 0) return <div className="text-center p-10 text-slate-400 border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50"><Icon name="calendar-off" size={32} className="mx-auto mb-2 opacity-30"/><p>{emptyMsg}</p></div>;
                 
                 return items.map(item => {
                    const serviceInfo = services.find(s => s.name === item.service_name);
                    return (
                        item.status === 'blocked' ? 
                        <div key={item.id} className="bg-slate-100 p-4 rounded-2xl border border-slate-200 opacity-70 flex justify-between items-center mb-3">
                            <div className="flex items-center text-slate-500 font-bold text-sm">
                                <Icon name="coffee" size={16} className="mr-2"/> 
                                {item.booking_date} {item.booking_time} {item.endTime && item.endTime !== item.booking_time && `~ ${item.endTime}`} (æ’ä¼‘)
                            </div>
                            <button onClick={()=>handleStatusChange(item.ids || item.id, 'cancelled')} className="text-xs text-red-400 underline hover:text-red-600">å–æ¶ˆæ™‚æ®µ</button>
                        </div>
                        :
                        <div key={item.id} className="bg-white p-5 rounded-2xl border border-emerald-100 shadow-sm relative overflow-hidden group mb-3">
                            <div className="absolute left-0 top-0 bottom-0 w-1.5 bg-emerald-500 transition-all group-hover:w-2"></div>
                            <div className="flex justify-between items-start mb-3 pl-3">
                                <div>
                                    <div className="text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded-md inline-flex items-center mb-2"><Icon name="clock" size={12} className="mr-1"/> {item.booking_date} {item.booking_time}</div>
                                    <div className="text-lg font-black text-slate-800 leading-tight">{item.service_name}</div>
                                    {serviceInfo && (
                                        <div className="text-xs text-slate-500 font-mono mt-1 mb-2">
                                            {serviceInfo.duration}åˆ†é˜ | ${serviceInfo.price}
                                        </div>
                                    )}
                                    <div className="text-sm text-slate-500 mt-1 flex items-center font-medium"><Icon name="user" size={14} className="mr-1.5 text-slate-400"/> {item.customer_name} <span className="text-slate-300 mx-1">|</span> {item.customer_phone}</div>
                                </div>
                            </div>
                            <div className="flex gap-3 mt-4 pl-3">
                                <button onClick={()=>handleStatusChange(item.id, 'completed')} className="flex-1 bg-slate-800 text-white py-3 rounded-xl text-sm font-bold shadow-lg hover:bg-slate-900 active:scale-95 transition flex items-center justify-center"><Icon name="check-circle" size={16} className="mr-2"/> å®Œæˆèª²ç¨‹</button>
                                <button onClick={()=>handleStatusChange(item.id, 'cancelled')} className="px-4 bg-white border border-slate-200 text-slate-400 py-3 rounded-xl text-sm font-bold hover:bg-red-50 hover:text-red-500 hover:border-red-200 transition"><Icon name="x" size={18}/></button>
                            </div>
                        </div>
                    );
                });
            }

            const mergeScheduleItems = (items) => {
                const merged = [];
                let currentBlock = null;
                items.forEach(item => {
                    if (item.status === 'blocked') {
                        if (currentBlock && currentBlock.booking_date === item.booking_date && currentBlock.status === 'blocked') {
                            currentBlock.endTime = item.booking_time;
                            currentBlock.ids.push(item.id);
                        } else {
                            if (currentBlock) merged.push(currentBlock);
                            currentBlock = { ...item, ids: [item.id], endTime: item.booking_time };
                        }
                    } else {
                        if (currentBlock) { merged.push(currentBlock); currentBlock = null; }
                        merged.push(item);
                    }
                });
                if (currentBlock) merged.push(currentBlock);
                return merged;
            };

            const stats = useMemo(() => {
                let total = 0, completed = 0, confirmed = 0;
                bookings.forEach(b => {
                    if (b.status === 'confirmed') { confirmed++; total++; }
                    if (b.status === 'completed') { completed++; total++; }
                });
                return { total, completed, confirmed };
            }, [bookings]);

            const today = new Date().toISOString().split('T')[0];
            const upcomingBookings = bookings.filter(b => (b.booking_date >= today && b.status === 'confirmed') || (b.booking_date === today && b.status === 'blocked')).reverse();
            const displaySchedule = mergeScheduleItems(upcomingBookings);
            const pastBookings = bookings.filter(b => (b.booking_date < today || b.status === 'completed' || b.status === 'cancelled') && b.status !== 'blocked').slice(0, 50);

            const bookingLink = staffData?.store_id ? new URL(`booking.html?store_id=${staffData.store_id}`, window.location.href).href : '';

            if (!staffId) return <div className="min-h-screen flex items-center justify-center text-slate-400">ç„¡æ•ˆçš„é€£çµ</div>;

            if (!isLoggedIn) return (
                <div className="min-h-screen flex items-center justify-center p-6 bg-slate-100">
                    <div className="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm text-center">
                        <div className="w-24 h-24 rounded-full mx-auto mb-4 flex items-center justify-center overflow-hidden border-4 border-slate-100 bg-slate-100 shadow-md">
                            {staffData?.avatar ? <img src={staffData.avatar} className="w-full h-full object-cover" /> : <div className="text-3xl">ğŸ”’</div>}
                        </div>
                        <h2 className="text-xl font-bold mb-2">{staffData?.name ? `${staffData.name} è€å¸«å°ˆå€` : 'è€å¸«å°ˆå€ç™»å…¥'}</h2>
                        <p className="text-slate-400 text-sm mb-6">è«‹è¼¸å…¥æ‚¨çš„å€‹äººç™»å…¥ç¢¼ (Passcode)</p>
                        <input type="tel" maxLength="6" className="w-full p-4 border rounded-xl mb-6 text-center text-2xl font-mono tracking-widest focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="0000" value={loginCode} onChange={e=>setLoginCode(e.target.value)}/>
                        <button onClick={()=>verifyLogin(staffId, loginCode)} disabled={loading} className="w-full bg-slate-800 text-white py-4 rounded-xl font-bold shadow-lg">{loading ? "é©—è­‰ä¸­..." : "é€²å…¥ç³»çµ±"}</button>
                    </div>
                </div>
            );

            return (
                <div className="max-w-md mx-auto min-h-screen bg-slate-50 pb-24 shadow-2xl relative">
                    {/* Header */}
                    <div className="bg-slate-900 text-white p-6 rounded-b-[2.5rem] shadow-xl mb-6 relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-32 h-32 bg-emerald-500 rounded-full blur-3xl opacity-20 -mr-10 -mt-10"></div>
                        <div className="flex justify-between items-start mb-6 relative z-10">
                            <div className="flex items-center">
                                <img src={staffData.avatar} className="w-16 h-16 rounded-full border-4 border-white/10 mr-4 bg-slate-800 object-cover shadow-lg"/>
                                <div><h1 className="text-2xl font-bold">{staffData.name}</h1><span className="text-xs bg-white/20 px-2 py-1 rounded-full text-emerald-100">{staffData.title}</span></div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={()=>setShowQRModal(true)} className="text-white/60 hover:text-white p-2 bg-white/10 rounded-full"><Icon name="qr-code" size={18}/></button>
                                <button onClick={()=>{localStorage.removeItem(`staff_session_${staffId}`); window.location.reload();}} className="text-white/60 hover:text-white p-2 bg-white/10 rounded-full"><Icon name="log-out" size={18}/></button>
                            </div>
                        </div>
                        <div className="grid grid-cols-3 gap-3 text-center relative z-10">
                            <div onClick={()=>setView('schedule')} className="bg-white/10 backdrop-blur-sm rounded-2xl p-3 border border-white/5 cursor-pointer hover:bg-white/20 transition active:scale-95"><div className="text-2xl font-bold">{stats.confirmed}</div><div className="text-[10px] text-slate-300 uppercase tracking-wider">å¾…åŸ·è¡Œ</div></div>
                            <div onClick={()=>setView('history')} className="bg-emerald-500/20 backdrop-blur-sm rounded-2xl p-3 border border-emerald-500/30 cursor-pointer hover:bg-emerald-500/30 transition active:scale-95"><div className="text-2xl font-bold text-emerald-300">{stats.completed}</div><div className="text-[10px] text-emerald-200 uppercase tracking-wider">å·²å®Œæˆ</div></div>
                            <div onClick={()=>setView('history')} className="bg-white/10 backdrop-blur-sm rounded-2xl p-3 border border-white/5 cursor-pointer hover:bg-white/20 transition active:scale-95"><div className="text-2xl font-bold">{stats.total}</div><div className="text-[10px] text-slate-300 uppercase tracking-wider">ç¸½é ç´„</div></div>
                        </div>
                    </div>

                    <div className="px-5">
                        {/* Tab Nav */}
                        <div className="flex bg-white p-1.5 rounded-2xl shadow-sm mb-6 border border-slate-100 overflow-x-auto hide-scrollbar gap-1">
                            <button onClick={()=>setView('schedule')} className={`flex-1 min-w-[80px] py-2.5 rounded-xl text-xs font-bold transition flex flex-col items-center justify-center ${view==='schedule' ? 'bg-slate-100 text-slate-800 shadow-inner' : 'text-slate-400'}`}><Icon name="list" size={16} className="mb-1"/> è¡Œç¨‹</button>
                            <button onClick={()=>setView('calendar')} className={`flex-1 min-w-[80px] py-2.5 rounded-xl text-xs font-bold transition flex flex-col items-center justify-center ${view==='calendar' ? 'bg-slate-100 text-slate-800 shadow-inner' : 'text-slate-400'}`}><Icon name="calendar" size={16} className="mb-1"/> æœˆæ›†</button>
                            <button onClick={()=>setView('clients')} className={`flex-1 min-w-[80px] py-2.5 rounded-xl text-xs font-bold transition flex flex-col items-center justify-center ${view==='clients' ? 'bg-slate-100 text-slate-800 shadow-inner' : 'text-slate-400'}`}><Icon name="users" size={16} className="mb-1"/> å®¢æˆ¶</button>
                            <button onClick={()=>setView('tools')} className={`flex-1 min-w-[80px] py-2.5 rounded-xl text-xs font-bold transition flex flex-col items-center justify-center ${view==='tools' ? 'bg-slate-100 text-slate-800 shadow-inner' : 'text-slate-400'}`}><Icon name="briefcase" size={16} className="mb-1"/> å·¥å…·</button>
                        </div>

                        {/* View: Schedule */}
                        {view === 'schedule' && (
                            <div className="space-y-4 animate-fade-in-up">
                                <h3 className="font-bold text-slate-400 text-xs uppercase ml-1 flex justify-between items-center">
                                    <span>ä»Šæ—¥ & æœªä¾†è¡Œç¨‹</span>
                                    {/* ä¿®æ­£ï¼šé¡¯ç¤ºå¡ç‰‡æ•¸é‡ */}
                                    <span className="bg-slate-200 text-slate-500 px-2 py-0.5 rounded-full">{displaySchedule.length}</span>
                                </h3>
                                <BookingList items={displaySchedule} emptyMsg="è¿‘æœŸç„¡é ç´„" />
                            </div>
                        )}

                        {/* View: Calendar */}
                        {view === 'calendar' && (
                            <CalendarView 
                                bookings={bookings} 
                                currentDate={calendarDate} 
                                onDateChange={setCalendarDate}
                                onDayClick={(dateStr, dayBookings) => setSelectedDayBookings({ date: dateStr, items: mergeScheduleItems(dayBookings) })}
                            />
                        )}
                        
                        {/* View: Clients */}
                        {view === 'clients' && <ClientsView storeId={staffData.store_id} loginCode={loginCode} supabase={supabaseClient} />}

                        {/* View: History */}
                        {view === 'history' && (
                            <div className="space-y-4 animate-fade-in-up">
                                <h3 className="font-bold text-slate-400 text-xs uppercase ml-1">æ­·å²ç´€éŒ„ (è¿‘50ç­†)</h3>
                                {pastBookings.length === 0 ? <div className="text-center p-10 text-slate-400 border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50"><Icon name="history" size={32} className="mx-auto mb-2 opacity-30"/><p>ç„¡æ­·å²ç´€éŒ„</p></div> :
                                pastBookings.map(b => (
                                    <div key={b.id} className="bg-white p-4 rounded-xl border border-slate-100 flex justify-between items-center hover:bg-slate-50 transition">
                                        <div>
                                            <div className="text-xs font-bold text-slate-400 mb-0.5">{b.booking_date} {b.booking_time}</div>
                                            <div className="font-bold text-slate-700 text-sm">{b.customer_name} - {b.service_name}</div>
                                        </div>
                                        <div>
                                            {b.status === 'completed' && <span className="bg-emerald-100 text-emerald-700 text-[10px] px-2 py-1 rounded-full font-bold">å·²å®Œæˆ</span>}
                                            {b.status === 'cancelled' && <span className="bg-slate-100 text-slate-400 text-[10px] px-2 py-1 rounded-full font-bold">å·²å–æ¶ˆ</span>}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* View: Tools */}
                        {view === 'tools' && (
                            <div className="space-y-6">
                                <WalkInBooking storeId={staffData.store_id} staffName={staffData.name} services={services} onBook={handleWalkIn} loading={loading} />
                                <LeaveRequest onApply={handleSelfLeave} loading={loading} />
                            </div>
                        )}
                    </div>

                    {/* QR Code Modal */}
                    {showQRModal && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-6 backdrop-blur-md animate-fade-in-up" onClick={()=>setShowQRModal(false)}>
                            <div className="bg-white p-8 rounded-3xl w-full max-w-sm text-center relative" onClick={e=>e.stopPropagation()}>
                                <button onClick={()=>setShowQRModal(false)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><Icon name="x" size={24}/></button>
                                <h3 className="text-xl font-bold text-slate-800 mb-2">{staffData.name} çš„å°ˆå±¬é ç´„ç¢¼</h3>
                                <p className="text-xs text-slate-400 mb-6">æƒæå¾Œç›´æ¥æŒ‡å®šæ‚¨é ç´„</p>
                                <div className="flex justify-center mb-6"><QRCodeViewer link={bookingLink} /></div>
                                <div className="flex gap-2">
                                    <input value={bookingLink} readOnly className="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-3 text-xs text-slate-500"/>
                                    <button onClick={()=>{navigator.clipboard.writeText(bookingLink); alert("é€£çµå·²è¤‡è£½");}} className="bg-slate-900 text-white px-4 py-3 rounded-xl font-bold text-sm">è¤‡è£½</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Day Detail Modal */}
                    {selectedDayBookings && (
                        <div className="fixed inset-0 bg-black/60 flex items-end sm:items-center justify-center z-50 sm:p-4 backdrop-blur-sm animate-fade-in-up" onClick={()=>setSelectedDayBookings(null)}>
                            <div className="bg-white w-full sm:max-w-md h-[80vh] sm:h-auto sm:rounded-3xl rounded-t-[2rem] flex flex-col relative" onClick={e=>e.stopPropagation()}>
                                <div className="p-6 border-b flex justify-between items-center">
                                    <h3 className="text-xl font-bold">{selectedDayBookings.date} è¡Œç¨‹</h3>
                                    <button onClick={()=>setSelectedDayBookings(null)} className="p-2 bg-slate-100 rounded-full"><Icon name="x" size={20}/></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-5 custom-scrollbar bg-slate-50 rounded-b-[2rem]">
                                    <BookingList items={selectedDayBookings.items} emptyMsg="ç•¶æ—¥ç„¡è¡Œç¨‹" />
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StaffApp />);
    </script>
</body>
</html>