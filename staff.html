<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amber Flow - 老師專區</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        /* 彈窗動畫 */
        @keyframes slide-up {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up { animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fade-in 0.2s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        
        // ★ Supabase 設定
        const supabaseUrl = 'https://kwvbhzjzysmivafsvwng.supabase.co';
        const supabaseKey = 'sb_publishable_7RUbenk2kXNDmvuo1XtHbQ_m0RjXuZr'; 
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // ★ 工具：生成 08:00 - 21:00 時段
        const ALL_TIME_SLOTS = [];
        for (let h = 8; h <= 21; h++) {
            ALL_TIME_SLOTS.push(`${h.toString().padStart(2, '0')}:00`);
            if (h < 21) ALL_TIME_SLOTS.push(`${h.toString().padStart(2, '0')}:30`);
        }

        const Icon = ({ name, size = 20, className="" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && window.lucide) {
                    ref.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    i.setAttribute('width', size);
                    i.setAttribute('height', size);
                    if(className) i.setAttribute('class', className);
                    ref.current.appendChild(i);
                    window.lucide.createIcons({ root: ref.current });
                }
            }, [name, className]);
            return <span ref={ref} className="inline-flex items-center"></span>;
        };

        // --- 1. 儀表板視圖 ---
        function DashboardView({ bookings, services }) {
            const today = new Date().toISOString().split('T')[0];
            const currentMonth = today.slice(0, 7); // YYYY-MM

            // 計算數據
            const stats = useMemo(() => {
                let todayRev = 0, monthRev = 0, todayCount = 0;
                
                bookings.forEach(b => {
                    const service = services.find(s => s.name === b.service_name);
                    const price = service ? service.price : 0;

                    // 只計算「已完成」或「已確認」的訂單
                    // ★ 排除 'no_show' (失約) 不計入營收
                    if (b.status === 'confirmed' || b.status === 'completed') {
                        if (b.booking_date === today) {
                            todayRev += price;
                            todayCount++;
                        }
                        if (b.booking_date.startsWith(currentMonth)) {
                            monthRev += price;
                        }
                    }
                });

                return { todayRev, monthRev, todayCount };
            }, [bookings, services, today]);

            return (
                <div className="p-6 space-y-6 animate-fade-in-up pb-24">
                    <div className="flex items-center justify-between mb-2">
                        <h2 className="text-2xl font-bold text-slate-800">個人儀表板</h2>
                        <span className="text-xs font-bold bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full">{today}</span>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <div className="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-4 text-white shadow-lg shadow-emerald-200">
                            <div className="text-emerald-100 text-xs font-bold mb-1 flex items-center"><Icon name="dollar-sign" size={14} className="mr-1"/> 今日營收</div>
                            <div className="text-2xl font-bold">${stats.todayRev.toLocaleString()}</div>
                        </div>
                        <div className="bg-white rounded-2xl p-4 border border-slate-100 shadow-sm">
                            <div className="text-slate-400 text-xs font-bold mb-1 flex items-center"><Icon name="users" size={14} className="mr-1"/> 今日課程</div>
                            <div className="text-2xl font-bold text-slate-800">{stats.todayCount} <span className="text-xs font-normal text-slate-400">堂</span></div>
                        </div>
                    </div>

                    <div className="bg-white rounded-2xl p-5 border border-slate-100 shadow-sm">
                        <div className="flex justify-between items-center mb-2">
                            <span className="text-sm font-bold text-slate-500">本月累計營收 ({currentMonth})</span>
                            <Icon name="trending-up" size={16} className="text-emerald-500" />
                        </div>
                        <div className="text-4xl font-bold text-slate-800">${stats.monthRev.toLocaleString()}</div>
                        <div className="mt-2 text-xs text-slate-400">包含已確認與已完成之訂單 (不含失約)</div>
                    </div>
                </div>
            );
        }

        // --- 2. 時間軸課表視圖 (格狀 + Modal) ---
        function ScheduleView({ bookings, selectedDate, setSelectedDate, services, onUpdateStatus }) {
            const [selectedBooking, setSelectedBooking] = useState(null); // 控制 Modal 顯示

            const changeDate = (offset) => {
                const date = new Date(selectedDate);
                date.setDate(date.getDate() + offset);
                setSelectedDate(date.toISOString().split('T')[0]);
            };

            const dailyBookings = bookings.filter(b => b.booking_date === selectedDate);

            // 取得課程價格 (用於顯示在 Modal)
            const getPrice = (serviceName) => {
                const s = services.find(svc => svc.name === serviceName);
                return s ? s.price : 0;
            };

            // 處理狀態更新
            const handleStatusChange = async (status) => {
                if (!selectedBooking) return;
                
                // 二次確認
                const confirmMsg = status === 'no_show' 
                    ? "確定要標記此學員為「失約」嗎？\n這將不會計入營收。" 
                    : "確定課程已完成？";
                
                if (!confirm(confirmMsg)) return;

                await onUpdateStatus(selectedBooking.id, status);
                setSelectedBooking(null); // 關閉視窗
            };

            return (
                <div className="flex flex-col h-full relative">
                    {/* 日期選擇器 */}
                    <div className="bg-white p-4 shadow-sm border-b sticky top-0 z-20 flex items-center justify-between">
                        <button onClick={() => changeDate(-1)} className="p-2 bg-slate-100 rounded-full hover:bg-slate-200 active:scale-95 transition"><Icon name="chevron-left" /></button>
                        <div className="font-bold text-lg text-slate-800">{selectedDate}</div>
                        <button onClick={() => changeDate(1)} className="p-2 bg-slate-100 rounded-full hover:bg-slate-200 active:scale-95 transition"><Icon name="chevron-right" /></button>
                    </div>

                    {/* 格狀課表 */}
                    <div className="flex-1 overflow-y-auto p-4 pb-24">
                        <div className="grid grid-cols-4 gap-3">
                            {ALL_TIME_SLOTS.map(time => {
                                const booking = dailyBookings.find(b => b.booking_time === time && b.status !== 'cancelled');
                                
                                // 狀態判斷
                                const isBlocked = booking?.status === 'blocked';
                                const isNoShow = booking?.status === 'no_show';
                                const isCompleted = booking?.status === 'completed';
                                const isBooked = booking && !isBlocked && !isNoShow;

                                // 卡片樣式邏輯
                                let cardClass = 'bg-white border-slate-100 text-slate-300'; // 預設空
                                if (isBlocked) cardClass = 'bg-red-50 border-red-200 text-red-800';
                                else if (isNoShow) cardClass = 'bg-gray-100 border-gray-300 text-gray-500 opacity-75 grayscale';
                                else if (isCompleted) cardClass = 'bg-blue-50 border-blue-200 text-blue-800';
                                else if (isBooked) cardClass = 'bg-emerald-50 border-emerald-200 text-emerald-800 shadow-sm';

                                return (
                                    <button 
                                        key={time}
                                        onClick={() => booking && setSelectedBooking(booking)}
                                        disabled={!booking}
                                        className={`flex flex-col items-center justify-center p-2 rounded-xl border min-h-[80px] transition relative overflow-hidden active:scale-95 ${cardClass}`}
                                    >
                                        <span className="text-xs font-bold mb-1 font-mono">{time}</span>
                                        {booking && !isBlocked ? (
                                            <>
                                                <div className="font-bold text-sm truncate w-full text-center">
                                                    {isNoShow ? <span className="line-through">{booking.customer_name}</span> : booking.customer_name}
                                                </div>
                                                <div className="text-[10px] opacity-70 truncate w-full text-center">
                                                    {isNoShow ? '(失約)' : isCompleted ? '(已完成)' : booking.service_name}
                                                </div>
                                            </>
                                        ) : isBlocked ? (
                                            <>
                                                <Icon name="coffee" size={16} className="mb-1 opacity-50"/>
                                                <div className="text-[10px] font-bold">排休</div>
                                            </>
                                        ) : (
                                            <div className="text-[10px] font-bold opacity-30">空</div>
                                        )}
                                    </button>
                                )
                            })}
                        </div>
                    </div>

                    {/* 預約詳情 Modal */}
                    {selectedBooking && (
                        <div className="fixed inset-0 z-50 flex items-end justify-center sm:items-center p-4">
                            <div className="absolute inset-0 bg-black/40 backdrop-blur-sm animate-fade-in" onClick={() => setSelectedBooking(null)}></div>
                            
                            <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl z-10 animate-slide-up overflow-hidden">
                                {/* Header */}
                                <div className={`p-6 text-white flex justify-between items-start 
                                    ${selectedBooking.status === 'blocked' ? 'bg-red-500' : 
                                      selectedBooking.status === 'no_show' ? 'bg-gray-500' : 
                                      selectedBooking.status === 'completed' ? 'bg-blue-600' : 'bg-emerald-600'}`}>
                                    <div>
                                        <div className="text-xs font-bold opacity-80 mb-1">{selectedBooking.booking_date}</div>
                                        <div className="text-3xl font-bold font-mono">{selectedBooking.booking_time}</div>
                                    </div>
                                    <button onClick={() => setSelectedBooking(null)} className="p-2 bg-white/20 rounded-full hover:bg-white/30 transition">
                                        <Icon name="x" size={20} className="text-white"/>
                                    </button>
                                </div>

                                {/* Content */}
                                <div className="p-6 space-y-5">
                                    {selectedBooking.status === 'blocked' ? (
                                        <div className="text-center py-4">
                                            <h3 className="text-xl font-bold text-slate-800">排休 / 請假</h3>
                                            <p className="text-slate-500 mt-2">原因：{selectedBooking.customer_name}</p>
                                        </div>
                                    ) : (
                                        <>
                                            <div className="flex items-start space-x-4">
                                                <div className="bg-slate-50 p-3 rounded-xl text-slate-600"><Icon name="user" size={24} /></div>
                                                <div>
                                                    <div className="text-xs text-slate-400 font-bold uppercase">學員姓名</div>
                                                    <div className="text-lg font-bold text-slate-800">{selectedBooking.customer_name}</div>
                                                    {/* 狀態標籤 */}
                                                    {selectedBooking.status === 'no_show' && <span className="bg-gray-100 text-gray-500 text-xs px-2 py-1 rounded font-bold mt-1 inline-block">已標記失約</span>}
                                                    {selectedBooking.status === 'completed' && <span className="bg-blue-100 text-blue-600 text-xs px-2 py-1 rounded font-bold mt-1 inline-block">課程已完成</span>}
                                                </div>
                                            </div>

                                            <div className="flex items-start space-x-4">
                                                <div className="bg-slate-50 p-3 rounded-xl text-slate-600"><Icon name="layers" size={24} /></div>
                                                <div>
                                                    <div className="text-xs text-slate-400 font-bold uppercase">預約課程</div>
                                                    <div className="text-lg font-bold text-slate-800">{selectedBooking.service_name}</div>
                                                    <div className="text-emerald-600 font-bold text-sm mt-1">${getPrice(selectedBooking.service_name).toLocaleString()}</div>
                                                </div>
                                            </div>

                                            <div className="flex items-start space-x-4">
                                                <div className="bg-slate-50 p-3 rounded-xl text-slate-600"><Icon name="phone" size={24} /></div>
                                                <div className="flex-1">
                                                    <div className="text-xs text-slate-400 font-bold uppercase">聯絡電話</div>
                                                    <div className="text-lg font-bold text-slate-800 font-mono tracking-wider">{selectedBooking.customer_phone}</div>
                                                </div>
                                                <a href={`tel:${selectedBooking.customer_phone}`} className="bg-slate-800 text-white px-4 py-2 rounded-lg text-xs font-bold shadow active:scale-95 transition">撥打</a>
                                            </div>
                                        </>
                                    )}
                                </div>

                                {/* Footer Actions (只在尚未完成或取消時顯示操作) */}
                                {selectedBooking.status === 'confirmed' && (
                                    <div className="p-4 bg-slate-50 border-t border-slate-100 grid grid-cols-2 gap-3">
                                        <button onClick={() => handleStatusChange('no_show')} className="w-full py-3 bg-white border border-slate-300 text-slate-500 font-bold rounded-xl hover:bg-slate-100 transition flex items-center justify-center">
                                            <Icon name="user-x" size={16} className="mr-2"/> 未出席
                                        </button>
                                        <button onClick={() => handleStatusChange('completed')} className="w-full py-3 bg-emerald-600 text-white font-bold rounded-xl hover:bg-emerald-700 shadow-lg shadow-emerald-200 transition flex items-center justify-center">
                                            <Icon name="check" size={16} className="mr-2"/> 完成課程
                                        </button>
                                    </div>
                                )}
                                {/* 如果已完成或已失約，只顯示關閉 */}
                                {(selectedBooking.status === 'completed' || selectedBooking.status === 'no_show') && (
                                    <div className="p-4 bg-slate-50 border-t border-slate-100">
                                        <button onClick={() => setSelectedBooking(null)} className="w-full py-3 bg-white border border-slate-200 text-slate-600 font-bold rounded-xl hover:bg-slate-50 transition">
                                            關閉
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- 主程式 ---
        function StaffApp() {
            const [staff, setStaff] = useState(null);
            const [inputCode, setInputCode] = useState('');
            const [view, setView] = useState('login'); 
            
            const [bookings, setBookings] = useState([]);
            const [services, setServices] = useState([]);
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const id = params.get('id');
                if (id) fetchStaff(id);
            }, []);

            async function fetchStaff(id) {
                const { data } = await supabase.from('staff').select('*').eq('id', id).single();
                if (data) setStaff(data);
            }

            const handleLogin = () => {
                if (staff && inputCode === (staff.login_code || '0000')) {
                    setView('dashboard');
                    fetchData(staff.name);
                } else {
                    alert("登入碼錯誤");
                }
            };

            async function fetchData(staffName) {
                const { data: svcData } = await supabase.from('services').select('name, price');
                if (svcData) setServices(svcData);

                const { data: bookingData } = await supabase.from('bookings')
                    .select('*')
                    .eq('staff_name', staffName)
                    .neq('status', 'cancelled');
                if (bookingData) setBookings(bookingData);
            }

            // ★ 更新狀態功能 (傳給 ScheduleView 用)
            async function updateBookingStatus(id, newStatus) {
                try {
                    const { error } = await supabase.from('bookings').update({ status: newStatus }).eq('id', id);
                    if (error) throw error;
                    // 更新本地資料
                    setBookings(prev => prev.map(b => b.id === id ? { ...b, status: newStatus } : b));
                } catch (err) {
                    alert("更新失敗: " + err.message);
                }
            }

            if (!staff) return <div className="flex h-screen items-center justify-center text-slate-400">載入中...</div>;

            if (view === 'login') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-6 bg-slate-50">
                        <div className="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm text-center">
                            <div className="w-20 h-20 rounded-full mx-auto mb-4 p-1 border-2 border-emerald-500">
                                <img src={staff.avatar} className="w-full h-full rounded-full object-cover" />
                            </div>
                            <h2 className="text-xl font-bold mb-1 text-slate-800">{staff.name}</h2>
                            <p className="text-xs text-slate-400 mb-6">Welcome back to Amber Flow</p>
                            
                            <input type="password" value={inputCode} onChange={e => setInputCode(e.target.value)} 
                                className="w-full p-4 bg-slate-100 border-none rounded-2xl text-center text-2xl tracking-[0.5em] mb-4 focus:ring-2 focus:ring-emerald-500 outline-none font-bold text-slate-700" 
                                maxLength="6" placeholder="••••" />
                            
                            <button onClick={handleLogin} className="w-full bg-slate-800 text-white py-4 rounded-2xl font-bold text-lg hover:bg-slate-900 shadow-lg shadow-slate-200 active:scale-95 transition">
                                解鎖進入
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="bg-slate-50 min-h-screen pb-20 max-w-md mx-auto shadow-2xl relative overflow-hidden flex flex-col">
                    <div className="bg-white p-4 flex justify-between items-center shadow-sm sticky top-0 z-10">
                         <div className="flex items-center">
                            <img src={staff.avatar} className="w-8 h-8 rounded-full border border-slate-100 mr-2" />
                            <span className="font-bold text-slate-700">{staff.name}</span>
                        </div>
                        <button onClick={() => fetchData(staff.name)} className="text-slate-400 hover:text-emerald-600"><Icon name="refresh-ccw" size={18}/></button>
                    </div>

                    <div className="flex-1 overflow-y-auto custom-scrollbar">
                        {view === 'dashboard' && <DashboardView bookings={bookings} services={services} />}
                        {/* 傳入 onUpdateStatus */}
                        {view === 'schedule' && <ScheduleView bookings={bookings} selectedDate={selectedDate} setSelectedDate={setSelectedDate} services={services} onUpdateStatus={updateBookingStatus} />}
                    </div>

                    <div className="fixed bottom-0 w-full max-w-md bg-white border-t border-slate-100 p-2 flex justify-around shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-30">
                        <button onClick={() => setView('dashboard')} className={`flex flex-col items-center p-2 rounded-xl w-full transition ${view === 'dashboard' ? 'text-emerald-600 bg-emerald-50' : 'text-slate-400 hover:bg-slate-50'}`}>
                            <Icon name="layout-grid" className="mb-1" />
                            <span className="text-[10px] font-bold">儀表板</span>
                        </button>
                        <button onClick={() => setView('schedule')} className={`flex flex-col items-center p-2 rounded-xl w-full transition ${view === 'schedule' ? 'text-emerald-600 bg-emerald-50' : 'text-slate-400 hover:bg-slate-50'}`}>
                            <Icon name="calendar-days" className="mb-1" />
                            <span className="text-[10px] font-bold">我的課表</span>
                        </button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StaffApp />);
    </script>
</body>
</html>