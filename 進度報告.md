
📦 EasyBook V3.2 專案進度與交接報告
1. 目前產品完成度 (Product Status)
系統架構已升級為 SaaS 多租戶版本，核心模組開發狀況如下：
✅ 已完成且運作正常
    • 平台總管 (SuperAdmin)：
        ◦ 可登入上帝後台 (superadmin.html)。
        ◦ 可查看所有店家列表（已修復 RPC 讀取問題）。
        ◦ 可開通新店家 (Provisioning)，並自動註冊店長帳號 (auth.users) 與綁定資料 (public.stores)。
    • 員工後台 (Staff App)：
        ◦ 可透過 Passcode 登入 (check_staff_login RPC)。
        ◦ 客戶查詢 (CRM)：可搜尋客戶，顯示「黑名單」、「消費金額」、「最後到訪日」（已透過 search_customers_for_staff RPC 修復）。
        ◦ 課表：可查看預約，並針對長時段課程佔用多個格子。
    • 前台預約 (Booking)：
        ◦ 支援 LINE Login。
        ◦ 支援「預約緩衝期」過濾。
        ◦ 支援「黑名單」攔截（前端邏輯已加，待後台資料驗證）。
    • 入口首頁 (Index)：
        ◦ 已更新為物理治療/瑜珈雙版本切換入口。
⚠️ 遇到的核心問題 (The Blocker)
問題描述：在 admin.html (商家後台) 中，店長登入後，「新增人員」與「新增課程」功能失效。
    • 現象：點擊儲存後，畫面提示「成功」，但列表依然是空的 (0 筆資料)。
    • 推測原因：RLS (Row Level Security) 權限死結。
        ◦ 雖然我們寫了 is_store_owner 函數，但在 INSERT (寫入) 和 SELECT (讀取) 的當下，資料庫判定該店長「無權限」操作這筆資料。
        ◦ 這通常是因為 auth.uid() 與 stores.owner_id 的關聯鍊在 RLS 執行層級中斷了。

2. 檔案版本清單 (Current File Versions)
請確保您手邊保留的是以下最新版本，下次我們基於這些檔案繼續：
檔案名稱
版本
狀態
備註
superadmin.html
V3.1
✅ 穩定
含 RPC 登入、RPC 列表讀取、開通商家功能。
staff.html
V3.1
✅ 穩定
含 RPC 客戶搜尋、消費統計、響應式優化。
booking.html
V3.0
✅ 穩定
含黑名單攔截、LINE 整合。
index.html
V3.1
✅ 穩定
物理治療版文案，連結至 #demo 區塊。
admin.html
V3.3
⚠️ 待修復
介面已響應式優化 (Mobile First)，但寫入資料庫失敗。

3. 明日修復計畫 (Next Steps)
下次開始時，我們不寫新功能，專注解決 Admin 寫入失敗 的問題。
預計執行步驟：
    1. 診斷 RLS：我會提供一個極簡的 SQL 測試腳本，直接在資料庫模擬「店長寫入員工」的動作，看資料庫噴什麼錯誤（是 new row violates RLS policy 還是其他）。
    2. 降級策略 (若 RLS 無解)：
        ◦ 如果 RLS 關聯太複雜導致一直失敗，我們將採用與 staff.html 相同的策略 —— 改用 RPC (後端函數) 來處理新增/修改/刪除。
        ◦ 優點：RPC 擁有 SECURITY DEFINER (上帝權限)，可以無視 RLS，由我們在程式碼裡手動檢查 store_id，保證 100% 能寫入。
    3. 驗證閉環：確認 Admin 新增員工 -> 資料庫有資料 -> Booking 前台看得到 -> Staff 後台能登入。

