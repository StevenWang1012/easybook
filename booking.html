<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyBook é ç´„ç³»çµ±</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
        @keyframes fade-in-up {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up { animation: fade-in-up 0.5s ease-out forwards; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* éš±è—æ»¾å‹•æ¢ä½†ä¿ç•™åŠŸèƒ½ */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // â˜… Supabase è¨­å®š
        const supabaseUrl = 'https://kwvbhzjzysmivafsvwng.supabase.co';
        const supabaseKey = 'sb_publishable_7RUbenk2kXNDmvuo1XtHbQ_m0RjXuZr'; 
        const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

        // â˜… æ ¸å¿ƒå·¥å…·ï¼šç”Ÿæˆæ™‚æ®µ (æ”¯æ´è·¨æ—¥)
        const generateTimeSlots = (openTime = "09:00", closeTime = "21:00") => {
            const slots = [];
            const [openH, openM] = openTime.split(':').map(Number);
            const [closeH, closeM] = closeTime.split(':').map(Number);

            let startMinutes = openH * 60 + openM;
            let endMinutes = closeH * 60 + closeM;

            // è™•ç†è·¨æ—¥ï¼šå¦‚æœçµæŸæ™‚é–“å°æ–¼é–‹å§‹æ™‚é–“ï¼ŒåŠ  24å°æ™‚
            if (endMinutes < startMinutes) {
                endMinutes += 24 * 60;
            }

            for (let m = startMinutes; m < endMinutes; m += 30) { // æ³¨æ„é€™è£¡ç”¨ < endMinutesï¼Œé€šå¸¸ä¸åŒ…å«æ‰“çƒŠé‚£ä¸€åˆ»
                let h = Math.floor(m / 60);
                let min = m % 60;
                let isNextDay = false;
                
                if (h >= 24) {
                    h -= 24;
                    isNextDay = true;
                }

                const timeStr = `${h.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
                
                slots.push({
                    time: timeStr,
                    isNextDay: isNextDay,
                    label: isNextDay ? `${timeStr} (éš”æ—¥)` : timeStr,
                    sortValue: m 
                });
            }
            return slots;
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && window.lucide) {
                    ref.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    i.setAttribute('width', size);
                    i.setAttribute('height', size);
                    if (className) i.setAttribute('class', className);
                    ref.current.appendChild(i);
                    window.lucide.createIcons({ root: ref.current });
                }
            }, [name, size, className]);
            return <span ref={ref} className="inline-flex items-center justify-center"></span>;
        };

        // --- å­çµ„ä»¶ï¼šè¨‚å–®åˆ—è¡¨ (MyBookings) ---
        function MyBookingsView({ onUpdateCount }) {
            const [phone, setPhone] = useState('');
            const [name, setName] = useState('');
            const [orders, setOrders] = useState([]);
            const [hasSearched, setHasSearched] = useState(false);
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                const savedUser = localStorage.getItem('amber_user');
                if (savedUser) {
                    const { name: savedName, phone: savedPhone } = JSON.parse(savedUser);
                    setName(savedName);
                    setPhone(savedPhone.replace(/^09/, '')); 
                    doSearch(savedName, savedPhone);
                }
            }, []);

            const doSearch = async (searchName, searchPhone) => {
                setLoading(true);
                setHasSearched(true);
                const today = new Date().toISOString().split('T')[0];

                try {
                    const { data, error } = await supabaseClient
                        .from('bookings')
                        .select('*')
                        .eq('customer_phone', searchPhone)
                        .eq('customer_name', searchName)
                        .gte('booking_date', today)
                        .neq('status', 'cancelled')
                        .order('booking_date', { ascending: true })
                        .order('booking_time', { ascending: true });

                    if (error) throw error;
                    setOrders(data || []);
                    if(onUpdateCount) onUpdateCount((data || []).length);
                    localStorage.setItem('amber_user', JSON.stringify({ name: searchName, phone: searchPhone }));

                } catch (err) {
                    console.error(err);
                    localStorage.removeItem('amber_user');
                } finally {
                    setLoading(false);
                }
            };

            const handleManualSearch = () => {
                if (!/^\d{8,10}$/.test(phone)) return alert("è«‹è¼¸å…¥æ­£ç¢ºçš„æ‰‹æ©Ÿè™Ÿç¢¼");
                if (!name.trim()) return alert("è«‹è¼¸å…¥é ç´„æ™‚çš„å§“å");
                const fullPhone = phone.length === 8 ? '09' + phone : phone;
                doSearch(name.trim(), fullPhone);
            };

            const handleCancel = async (id) => {
                if(!confirm("ç¢ºå®šè¦å–æ¶ˆæ­¤é ç´„å—ï¼Ÿ")) return;
                try {
                    const { error } = await supabaseClient.from('bookings').update({ status: 'cancelled' }).eq('id', id);
                    if(error) throw error;
                    const newOrders = orders.filter(o => o.id !== id);
                    setOrders(newOrders);
                    if(onUpdateCount) onUpdateCount(newOrders.length);
                    alert("å·²å–æ¶ˆé ç´„ï¼");
                } catch(err) {
                    alert("å–æ¶ˆå¤±æ•—ï¼š" + err.message);
                }
            };

            return (
                <div className="p-6 animate-fade-in-up pb-24">
                    <h2 className="text-2xl font-bold text-slate-800 mb-6">æˆ‘çš„é ç´„</h2>

                    {!hasSearched || orders.length === 0 ? (
                        <div className="mb-8 space-y-4">
                            {!hasSearched && <div className="bg-emerald-50 p-4 rounded-xl text-xs text-emerald-800 border border-emerald-100 mb-4">
                                <Icon name="shield-check" size={14} className="inline mr-1"/> è«‹è¼¸å…¥é ç´„æ™‚çš„æ‰‹æ©Ÿèˆ‡å§“åä»¥é©—è­‰èº«åˆ†ã€‚
                            </div>}
                            
                            <div>
                                <label className="block text-xs font-bold text-slate-400 mb-1 uppercase">æ‰‹æ©Ÿè™Ÿç¢¼</label>
                                <input type="tel" value={phone} onChange={e => setPhone(e.target.value.replace(/\D/g,''))} placeholder="09xxxxxxxx" className="w-full p-3 bg-white border border-slate-200 rounded-xl font-bold outline-none focus:ring-2 focus:ring-emerald-500"/>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-400 mb-1 uppercase">é ç´„å§“å</label>
                                <input type="text" value={name} onChange={e => setName(e.target.value)} placeholder="è«‹è¼¸å…¥å…¨å" className="w-full p-3 bg-white border border-slate-200 rounded-xl font-bold outline-none focus:ring-2 focus:ring-emerald-500"/>
                            </div>
                            <button onClick={handleManualSearch} disabled={loading} className="w-full bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900 transition flex justify-center items-center shadow-lg active:scale-95">
                                {loading ? 'æŸ¥è©¢ä¸­...' : <><Icon name="search" className="mr-2"/> æŸ¥è©¢ç´€éŒ„</>}
                            </button>
                        </div>
                    ) : null}

                    {hasSearched && (
                        <div>
                            {orders.length === 0 ? (
                                <div className="text-center py-10 bg-white rounded-2xl border border-dashed border-slate-200 text-slate-400">
                                    <Icon name="calendar-off" size={32} className="mx-auto mb-2 opacity-50"/>
                                    <p>ç›®å‰æ²’æœ‰é ç´„è¡Œç¨‹</p>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    <div className="flex justify-between items-end mb-2">
                                        <h3 className="font-bold text-slate-700">å³å°‡åˆ°ä¾† ({orders.length})</h3>
                                        <button onClick={() => {localStorage.removeItem('amber_user'); setHasSearched(false); setOrders([]); setPhone(''); setName(''); onUpdateCount(0);}} className="text-xs text-slate-400 underline">ç™»å‡º / æ¸…é™¤ç´€éŒ„</button>
                                    </div>
                                    {orders.map(order => (
                                        <div key={order.id} className="bg-white p-5 rounded-2xl border-l-4 border-emerald-500 shadow-sm relative group hover:shadow-md transition">
                                            <div className="flex justify-between items-start mb-3">
                                                <div>
                                                    <div className="text-xs font-bold text-emerald-600 mb-1 flex items-center"><Icon name="calendar" size={12} className="mr-1"/>{order.booking_date}</div>
                                                    <div className="text-3xl font-bold text-slate-800 font-mono tracking-tight">{order.booking_time}</div>
                                                </div>
                                                <button onClick={() => handleCancel(order.id)} className="text-xs bg-slate-100 text-slate-500 px-3 py-1.5 rounded-lg hover:bg-red-50 hover:text-red-500 transition font-bold">å–æ¶ˆ</button>
                                            </div>
                                            <div className="pt-3 border-t border-slate-50 flex justify-between items-center text-sm">
                                                <span className="font-bold text-slate-700 flex items-center"><Icon name="layers" size={14} className="mr-1 text-slate-400"/> {order.service_name}</span>
                                                <span className="text-slate-500 flex items-center bg-slate-50 px-2 py-1 rounded-md text-xs"><Icon name="user" size={12} className="mr-1"/>{order.staff_name}</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        // --- ä¸»ç¨‹å¼å…ƒä»¶ ---
        function BookingApp() {
            const [activeTab, setActiveTab] = useState('booking'); 
            const [badgeCount, setBadgeCount] = useState(0); 

            const [step, setStep] = useState(1);
            const [storeInfo, setStoreInfo] = useState(null);
            const [services, setServices] = useState([]);
            const [staffList, setStaffList] = useState([]);
            const [loading, setLoading] = useState(true);
            
            const [selectedService, setSelectedService] = useState(null);
            const [selectedStaff, setSelectedStaff] = useState(null);
            const [selectedTimeObj, setSelectedTimeObj] = useState(null); // æ”¹å­˜ç‰©ä»¶ï¼ŒåŒ…å« isNextDay
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            
            const [bookedSlots, setBookedSlots] = useState([]);
            const [isCheckingSlots, setIsCheckingSlots] = useState(false);
            const [showInfoModal, setShowInfoModal] = useState(false);
            const [customerInfo, setCustomerInfo] = useState({ name: '', phone: '' });
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [error, setError] = useState('');

            // â˜… å‹•æ…‹è¨ˆç®—æ™‚æ®µ (æ ¹æ“š storeInfo)
            const dynamicSlots = useMemo(() => {
                if(!storeInfo) return [];
                // å¦‚æœè³‡æ–™åº«æ²’è¨­å®šï¼Œé è¨­ 09:00 - 21:00
                return generateTimeSlots(storeInfo.open_time || "09:00", storeInfo.close_time || "21:00");
            }, [storeInfo]);

            useEffect(() => {
                async function init() {
                    try {
                        setLoading(true);
                        // 1. æŠ“å–åº—é‹ªè³‡æ–™
                        const { data: stores } = await supabaseClient.from('stores').select('*').limit(1);
                        if (stores && stores.length > 0) {
                            setStoreInfo({ 
                                ...stores[0], 
                                description: stores[0].description || "æ‰¾å›èº«é«”çš„æµå‹•èˆ‡å¹³è¡¡ã€‚", 
                                address: stores[0].address || "å°åŒ—å¸‚", 
                                lineUrl: stores[0].line_url 
                            });
                        }
                        const { data: svc } = await supabaseClient.from('services').select('*');
                        if (svc) setServices(svc.filter(i => !i.deleted_at));
                        const { data: stf } = await supabaseClient.from('staff').select('*').order('rating', { ascending: false });
                        if (stf) setStaffList(stf.filter(i => !i.deleted_at));

                        const savedUser = localStorage.getItem('amber_user');
                        if (savedUser) {
                            const { name, phone } = JSON.parse(savedUser);
                            const today = new Date().toISOString().split('T')[0];
                            const { count } = await supabaseClient.from('bookings').select('*', { count: 'exact', head: true })
                                .eq('customer_phone', phone).eq('customer_name', name).gte('booking_date', today).neq('status', 'cancelled');
                            if(count) setBadgeCount(count);
                        }
                    } catch (err) { console.error(err); } finally { setLoading(false); }
                }
                init();
            }, []);

            // æª¢æŸ¥æ™‚æ®µä½”ç”¨ (åŒ…å«è·¨æ—¥é‚è¼¯)
            useEffect(() => { if (step === 3 && selectedStaff) fetchAvailability(); }, [step, selectedDate, selectedStaff]);

            async function fetchAvailability() {
                setIsCheckingSlots(true);
                try {
                    // â˜… æŸ¥è©¢ç¯„åœæ“´å¤§ï¼šæŸ¥ã€Œé¸å–æ—¥æœŸã€ä»¥åŠã€Œé¸å–æ—¥æœŸ + 1å¤©ã€(ç‚ºäº†è™•ç†è·¨æ—¥é‡ç–Š)
                    const nextDate = new Date(selectedDate);
                    nextDate.setDate(nextDate.getDate() + 1);
                    const nextDateStr = nextDate.toISOString().split('T')[0];

                    let query = supabaseClient.from('bookings').select('booking_date, booking_time, service_name, status')
                        .in('booking_date', [selectedDate, nextDateStr])
                        .neq('status', 'cancelled'); 
                    
                    if (!selectedStaff.isAny) query = query.eq('staff_name', selectedStaff.name);
                    const { data: bookingsData } = await query;

                    const takenSlots = new Set();
                    if (bookingsData) {
                        bookingsData.forEach(booking => {
                            // è¨ˆç®—è©²é ç´„çš„ã€Œçµ•å°é–‹å§‹åˆ†é˜æ•¸ã€(ç›¸å°æ–¼ selectedDate 00:00)
                            const [bH, bM] = booking.booking_time.split(':').map(Number);
                            let bookingStartMins = bH * 60 + bM;
                            
                            // å¦‚æœé€™ç­†è¨‚å–®æ˜¯ã€Œéš”å¤©ã€çš„ï¼Œåˆ†é˜æ•¸è¦åŠ  24*60
                            if (booking.booking_date === nextDateStr) {
                                bookingStartMins += 24 * 60;
                            }

                            let duration = 30;
                            if (booking.status !== 'blocked') {
                                const service = services.find(s => s.name === booking.service_name);
                                if (service) duration = service.duration;
                            }
                            
                            // æ¨™è¨˜ä½”ç”¨æ™‚æ®µ
                            const slotsCount = Math.ceil(duration / 30);
                            for (let i = 0; i < slotsCount; i++) {
                                let currentTotalMinutes = bookingStartMins + (i * 30);
                                takenSlots.add(currentTotalMinutes);
                            }
                        });
                    }
                    
                    // æ¯”å° dynamicSlots
                    const finalBookedSlots = [];
                    const currentServiceDuration = selectedService ? selectedService.duration : 30;
                    const slotsNeeded = Math.ceil(currentServiceDuration / 30);

                    dynamicSlots.forEach(slot => {
                        // slot.sortValue æ˜¯è©²æ™‚æ®µçš„çµ•å°åˆ†é˜æ•¸ (è·¨æ—¥å·²åŠ  1440)
                        const startMins = slot.sortValue;
                        
                        // æª¢æŸ¥èµ·å§‹é»æ˜¯å¦è¢«ä½”ç”¨
                        if (takenSlots.has(startMins)) { 
                            finalBookedSlots.push(slot.time); // é€™è£¡å­˜ time string æ–¹ä¾¿æ¯”å° UI
                            return; 
                        }

                        // æª¢æŸ¥é€£çºŒæ™‚æ®µ
                        if (slotsNeeded > 1) {
                            let isConflict = false;
                            for (let i = 1; i < slotsNeeded; i++) {
                                const checkMins = startMins + (i * 30);
                                if (takenSlots.has(checkMins)) { isConflict = true; break; }
                            }
                            if (isConflict) finalBookedSlots.push(slot.time);
                        }
                    });
                    
                    setBookedSlots(finalBookedSlots);
                } catch (err) { console.error(err); } finally { setIsCheckingSlots(false); }
            }

            const handleConfirm = async () => {
                const phoneSuffixRegex = /^\d{8}$/;
                if (!phoneSuffixRegex.test(customerInfo.phone)) { setError('è«‹è¼¸å…¥å®Œæ•´çš„æ‰‹æ©Ÿè™Ÿç¢¼ (å¾Œ 8 ç¢¼)'); return; }
                const fullPhoneNumber = '09' + customerInfo.phone;
                
                // â˜… è™•ç†è·¨æ—¥å­˜æª”æ—¥æœŸ
                let finalDate = selectedDate;
                if (selectedTimeObj.isNextDay) {
                    const d = new Date(selectedDate);
                    d.setDate(d.getDate() + 1);
                    finalDate = d.toISOString().split('T')[0];
                }

                setIsSubmitting(true);
                try {
                    const { error: insertError } = await supabaseClient.from('bookings').insert([{
                        store_id: storeInfo.id,
                        service_name: selectedService.name,
                        staff_name: selectedStaff.name,
                        booking_date: finalDate, // ä½¿ç”¨è¨ˆç®—å¾Œçš„æ—¥æœŸ
                        booking_time: selectedTimeObj.time, // å­˜å…¥åŸå§‹ HH:MM
                        customer_name: customerInfo.name,
                        customer_phone: fullPhoneNumber,
                        status: 'confirmed',
                        device_info: navigator.userAgent
                    }]);
                    if (insertError) throw insertError;
                    
                    localStorage.setItem('amber_user', JSON.stringify({ name: customerInfo.name, phone: fullPhoneNumber }));
                    setBadgeCount(prev => prev + 1);
                    setStep(5);

                } catch (err) {
                    alert("é ç´„éŒ¯èª¤: " + err.message);
                } finally { setIsSubmitting(false); }
            };

            const generateGoogleCalendarUrl = () => {
                if (!selectedService || !selectedDate || !selectedTimeObj) return '#';
                
                // è¨ˆç®—æ­£ç¢ºçš„é–‹å§‹èˆ‡çµæŸæ™‚é–“ (å«è·¨æ—¥)
                let startD = new Date(selectedDate);
                if (selectedTimeObj.isNextDay) startD.setDate(startD.getDate() + 1);
                
                const [h, m] = selectedTimeObj.time.split(':').map(Number);
                startD.setHours(h, m);
                
                const endD = new Date(startD);
                endD.setMinutes(endD.getMinutes() + selectedService.duration);

                const formatGCalTime = (date) => {
                    return date.toISOString().replace(/-|:|\.\d\d\d/g, ""); // ISO è½‰ Google æ ¼å¼
                };

                const title = encodeURIComponent(`${storeInfo.name} - ${selectedService.name}`);
                const details = encodeURIComponent(`æŒ‡å°è€å¸«ï¼š${selectedStaff.name}\né ç´„ç·¨è™Ÿï¼š${customerInfo.phone}`);
                const location = encodeURIComponent(storeInfo.address);

                return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${formatGCalTime(startD)}/${formatGCalTime(endD)}&details=${details}&location=${location}`;
            };

            const handleServiceSelect = (service) => { setSelectedService(service); setStep(2); };
            const handleStaffSelect = (staff) => { setSelectedStaff(staff); setStep(3); };
            // æ”¹ç‚ºæ¥æ”¶æ•´å€‹ slot ç‰©ä»¶
            const handleTimeSelect = (slotObj) => { setSelectedTimeObj(slotObj); setStep(4); };

            if (loading) return <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50"><div className="loader mb-4"></div><p className="text-slate-500">è¼‰å…¥ä¸­...</p></div>;
            if (!storeInfo) return <div className="text-center p-10">è³‡æ–™åº«æœªé€£æ¥</div>;

            return (
                <div className="min-h-screen bg-gradient-to-br from-stone-50 to-emerald-50 flex justify-center md:p-4 relative">
                    <div className="w-full h-screen rounded-none md:max-w-md md:h-[85vh] md:rounded-[32px] bg-white shadow-2xl flex flex-col overflow-hidden relative border-0 md:border border-white/50">
                        
                        {/* å…§å®¹å€åŸŸ */}
                        <div className="flex-1 overflow-y-auto custom-scrollbar bg-white">
                            
                            {/* åˆ†é ï¼šé ç´„é¦–é  */}
                            {activeTab === 'booking' && (
                                <>
                                    <header className="bg-white/80 backdrop-blur-md p-4 border-b border-stone-100 flex items-center sticky top-0 z-20">
                                        {step > 1 && step < 5 && <button onClick={() => setStep(step - 1)} className="mr-2 p-2 rounded-full hover:bg-stone-100"><Icon name="chevron-left" /></button>}
                                        <div className="flex-1 text-center font-bold text-stone-700">
                                            {step === 1 ? "é ç´„èª²ç¨‹" : step === 2 ? "é¸æ“‡æŒ‡å°è€å¸«" : step === 3 ? "é¸æ“‡æ™‚æ®µ" : step === 4 ? "ç¢ºèªè³‡æ–™" : "é ç´„å®Œæˆ"}
                                        </div>
                                        {step > 1 && step < 5 && <div className="w-10"></div>}
                                    </header>

                                    {step < 5 && <div className="w-full bg-stone-100 h-1"><div className="bg-emerald-500 h-1 transition-all duration-500" style={{ width: `${(step / 4) * 100}%` }}></div></div>}

                                    <div className="p-5 pb-24">
                                        {step === 1 && (
                                            <div className="space-y-6 animate-fade-in-up">
                                                <div className="text-center py-4">
                                                    <div className="flex items-center justify-center mb-2"><h1 className="text-2xl font-bold text-stone-800">{storeInfo.name}</h1><button onClick={() => setShowInfoModal(true)} className="ml-2 text-stone-400 hover:text-emerald-600"><Icon name="info" size={20} /></button></div>
                                                    <p className="text-sm text-stone-500 mt-1 px-4 whitespace-pre-wrap">{storeInfo.description}</p>
                                                    <div className="flex items-center justify-center mt-3 text-xs text-stone-400"><Icon name="map-pin" size={14} className="mr-1 text-emerald-500" />{storeInfo.address}</div>
                                                </div>
                                                <div className="space-y-4">{services.map(service => (<div key={service.id} onClick={() => handleServiceSelect(service)} className="bg-white border border-stone-100 rounded-2xl p-5 hover:border-emerald-400 hover:shadow-lg cursor-pointer transition-all active:scale-95 group"><div className="flex justify-between"><div><h3 className="font-bold text-lg text-stone-800 group-hover:text-emerald-700">{service.name}</h3><p className="text-xs text-stone-400 mt-1">{service.description}</p><div className="flex items-center text-xs text-stone-400 mt-2 font-medium"><span className="mr-1">ğŸ•’</span> {service.duration} åˆ†é˜</div></div><span className="text-lg font-bold text-emerald-600 font-mono">${service.price}</span></div></div>))}</div>
                                            </div>
                                        )}
                                        {step === 2 && (
                                            <div className="space-y-4 animate-fade-in-up">
                                                <div className="bg-emerald-50 p-3 rounded-xl text-sm text-emerald-800 border border-emerald-100 flex justify-between"><span>èª²ç¨‹ï¼š{selectedService.name}</span><span className="font-bold">${selectedService.price}</span></div>
                                                <div onClick={() => handleStaffSelect({ id: 'any', name: 'ä¸æŒ‡å®šè€å¸«', avatar: '', isAny: true })} className="border border-dashed border-stone-300 rounded-2xl p-4 flex items-center hover:bg-emerald-50 cursor-pointer"><div className="w-12 h-12 bg-stone-100 rounded-full flex items-center justify-center mr-4 text-xl">ğŸ§˜</div><div><h3 className="font-bold text-stone-700">ä¸æŒ‡å®š (æœ€å¿«å¯ç´„)</h3><p className="text-xs text-stone-400">ç”±ç³»çµ±å®‰æ’åˆé©æ•™ç·´</p></div></div>
                                                <div className="grid grid-cols-2 gap-3">{staffList.map(staff => (<div key={staff.id} onClick={() => handleStaffSelect(staff)} className="border border-stone-100 rounded-2xl p-4 flex flex-col items-center hover:border-emerald-500 hover:shadow-md cursor-pointer bg-white group"><img src={staff.avatar} className="w-16 h-16 rounded-full mb-2 bg-stone-50 group-hover:scale-105 transition-transform object-cover" /><h3 className="font-bold text-stone-700">{staff.name}</h3><span className="text-[10px] bg-stone-100 text-stone-500 px-2 py-1 rounded mt-1">{staff.title}</span></div>))}</div>
                                            </div>
                                        )}
                                        {step === 3 && (
                                            <div className="animate-fade-in-up">
                                                <div className="flex space-x-2 mb-6 text-xs"><span className="bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full">{selectedService.name}</span><span className="bg-stone-100 text-stone-600 px-3 py-1 rounded-full">{selectedStaff.name}</span></div>
                                                <div className="mb-6"><label className="block text-xs font-bold text-stone-400 mb-2 uppercase">é ç´„æ—¥æœŸ</label><input type="date" value={selectedDate} onChange={e => setSelectedDate(e.target.value)} className="w-full p-3 bg-white border border-stone-200 rounded-xl font-bold text-stone-700"/></div>
                                                <h3 className="font-bold mb-4 flex items-center text-stone-700"><Icon name="calendar" size={16} className="mr-2"/> é¸æ“‡æ™‚æ®µ {isCheckingSlots && <span className="ml-2 text-xs font-normal text-slate-400">æŸ¥è©¢ä¸­...</span>}</h3>
                                                <div className="grid grid-cols-3 gap-2">
                                                    {dynamicSlots.map(slot => { 
                                                        const isTaken = bookedSlots.includes(slot.time); 
                                                        return (
                                                            <button key={slot.label} onClick={() => !isTaken && handleTimeSelect(slot)} disabled={isTaken} className={`py-3 px-1 border rounded-lg text-sm font-medium transition active:scale-95 flex flex-col items-center justify-center ${isTaken ? 'bg-stone-100 text-stone-300 border-stone-100 cursor-not-allowed' : 'bg-white hover:bg-emerald-600 hover:text-white hover:border-emerald-600 text-stone-600 border-stone-200'}`}>
                                                                {slot.label}
                                                                {isTaken && <span className="text-[9px] font-normal">å·²é¡æ»¿</span>}
                                                            </button>
                                                        ); 
                                                    })}
                                                </div>
                                            </div>
                                        )}
                                        {step === 4 && (
                                            <div className="space-y-6 animate-fade-in-up">
                                                <div className="bg-white border border-stone-100 shadow-lg rounded-2xl overflow-hidden"><div className="bg-emerald-600 p-3 text-white font-bold text-center">é ç´„ç¢ºèª</div><div className="p-5 space-y-3 text-sm"><div className="flex justify-between"><span className="text-stone-400">èª²ç¨‹</span><span className="font-medium text-stone-700">{selectedService.name}</span></div><div className="flex justify-between"><span className="text-stone-400">è€å¸«</span><span className="font-medium text-stone-700">{selectedStaff.name}</span></div><div className="flex justify-between"><span className="text-stone-400">æ™‚é–“</span><span className="font-bold text-emerald-600">{selectedDate} {selectedTimeObj?.label}</span></div><div className="pt-3 border-t border-stone-100 flex justify-between items-center"><span className="text-stone-400">è²»ç”¨</span><span className="text-xl font-bold text-stone-800">${selectedService.price}</span></div></div></div>
                                                <div className="space-y-4"><div><label className="block text-xs font-bold text-stone-400 mb-1 ml-1 uppercase">å§“å</label><input type="text" placeholder="æ‚¨çš„ç¨±å‘¼" value={customerInfo.name} onChange={(e) => setCustomerInfo({...customerInfo, name: e.target.value})} className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none"/></div><div><label className="block text-xs font-bold text-stone-400 mb-1 ml-1 uppercase">æ‰‹æ©Ÿ</label><div className="relative"><div className="absolute left-0 top-0 bottom-0 flex items-center pl-4 pointer-events-none"><span className="text-stone-500 font-bold border-r border-stone-300 pr-2 mr-2">09</span></div><input type="tel" maxLength="8" value={customerInfo.phone} onChange={(e) => { const val = e.target.value.replace(/\D/g, ''); setCustomerInfo({...customerInfo, phone: val}); setError(''); }} className={`w-full pl-16 pr-4 py-3 bg-stone-50 border rounded-xl focus:ring-2 outline-none ${error ? 'border-red-500 bg-red-50' : 'border-stone-200 focus:ring-emerald-500'}`}/></div>{error && <p className="text-red-500 text-xs mt-1 ml-1">{error}</p>}</div></div>
                                                <button onClick={handleConfirm} disabled={isSubmitting} className={`w-full text-white py-4 rounded-xl font-bold text-lg shadow-xl active:scale-95 transition-all ${isSubmitting ? 'bg-stone-400 cursor-not-allowed' : 'bg-stone-800 hover:bg-stone-900'}`}>{isSubmitting ? 'è™•ç†ä¸­...' : 'ç¢ºèªé ç´„'}</button>
                                            </div>
                                        )}
                                        {step === 5 && (
                                            <div className="text-center pt-8 animate-fade-in-up">
                                                <div className="w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4"><Icon name="check" size={40} className="text-emerald-600" /></div>
                                                <h2 className="text-2xl font-bold text-stone-800 mb-2">é ç´„æˆåŠŸï¼</h2>
                                                <p className="text-stone-500 text-sm mb-8">æ„Ÿè¬æ‚¨çš„é ç´„ï¼ŒæœŸå¾…èˆ‡æ‚¨åœ¨å¢Šä¸Šç›¸è¦‹ã€‚</p>
                                                <div className="bg-stone-50 p-6 rounded-2xl text-left mb-6 border border-stone-200"><div className="flex items-center mb-4"><Icon name="calendar" className="mr-3 text-emerald-500"/><div><h3 className="font-bold text-stone-800">{selectedDate}</h3><p className="text-emerald-600 font-bold">{selectedTimeObj?.label}</p></div></div><div className="text-sm text-stone-500 space-y-1 pl-9 border-l-2 border-stone-200 ml-2"><p>èª²ç¨‹ï¼š{selectedService.name}</p><p>è€å¸«ï¼š{selectedStaff.name}</p><p>é›»è©±ï¼š09{customerInfo.phone}</p></div></div>
                                                
                                                <a href={generateGoogleCalendarUrl()} target="_blank" className="block w-full bg-white border border-slate-200 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-50 hover:text-emerald-600 transition mb-3 flex items-center justify-center shadow-sm">
                                                    <Icon name="calendar-plus" size={18} className="mr-2"/> åŠ å…¥ Google æ—¥æ›†
                                                </a>

                                                <a href={storeInfo.lineUrl} target="_blank" className="block w-full bg-[#06c755] text-white py-3 rounded-xl font-bold hover:bg-[#05b34c] transition flex items-center justify-center shadow-lg shadow-green-500/20"><span className="mr-2 text-xl">ğŸ’¬</span> åŠ å…¥ LINE æ¥æ”¶æé†’</a>
                                            </div>
                                        )}
                                    </div>
                                </>
                            )}

                            {activeTab === 'orders' && <MyBookingsView onUpdateCount={setBadgeCount} />}
                        </div>

                        {/* åº•éƒ¨å°è¦½åˆ— */}
                        <div className="bg-white border-t border-slate-200 p-2 flex justify-around items-center absolute bottom-0 w-full shadow-[0_-4px_10px_rgba(0,0,0,0.05)] z-30">
                            <button onClick={() => { setActiveTab('booking'); if(step === 5) { setStep(1); setSelectedTimeObj(null); } }} className={`flex flex-col items-center flex-1 py-2 rounded-xl transition active:scale-95 ${activeTab === 'booking' ? 'text-emerald-600 bg-emerald-50' : 'text-slate-400 hover:bg-slate-50'}`}>
                                <Icon name="calendar-plus" size={24} className="mb-1"/>
                                <span className="text-[10px] font-bold">é ç´„èª²ç¨‹</span>
                            </button>
                            <button onClick={() => setActiveTab('orders')} className={`flex flex-col items-center flex-1 py-2 rounded-xl transition active:scale-95 relative ${activeTab === 'orders' ? 'text-emerald-600 bg-emerald-50' : 'text-slate-400 hover:bg-slate-50'}`}>
                                <div className="relative">
                                    <Icon name="clipboard-list" size={24} className="mb-1"/>
                                    {badgeCount > 0 && <span className="absolute -top-1 -right-2 bg-red-500 text-white text-[10px] font-bold px-1.5 min-w-[18px] h-[18px] rounded-full flex items-center justify-center shadow-sm animate-pulse">{badgeCount}</span>}
                                </div>
                                <span className="text-[10px] font-bold">æˆ‘çš„è¨‚å–®</span>
                            </button>
                        </div>

                        <a href="admin.html" className="absolute bottom-20 right-4 bg-slate-800/10 text-slate-400 p-2 rounded-full hover:bg-slate-800 hover:text-white transition z-20" title="å‰å¾€å•†å®¶å¾Œå°"><Icon name="settings" size={16} /></a>

                        {showInfoModal && <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-6 backdrop-blur-sm animate-fade-in-up"><div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm relative"><button onClick={() => setShowInfoModal(false)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><Icon name="x" size={24} /></button><h3 className="text-xl font-bold text-stone-800 mb-4 flex items-center"><Icon name="info" className="mr-2 text-emerald-500" /> èª²ç¨‹é ç´„é ˆçŸ¥</h3><div className="text-sm text-stone-600 space-y-3 leading-relaxed whitespace-pre-wrap">{storeInfo.terms}</div><button onClick={() => setShowInfoModal(false)} className="w-full mt-6 bg-stone-800 text-white py-3 rounded-xl font-bold hover:bg-stone-900 transition">æˆ‘äº†è§£äº†</button></div></div>}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<BookingApp />);
    </script>
</body>
</html>