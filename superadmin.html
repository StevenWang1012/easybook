<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easybook - 平台管理中心</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ★ Supabase 設定
        const supabaseUrl = 'https://kwvbhzjzysmivafsvwng.supabase.co';
        const supabaseKey = 'sb_publishable_7RUbenk2kXNDmvuo1XtHbQ_m0RjXuZr'; 
        const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

        const Icon = ({ name, size = 20, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (!ref.current || !window.lucide) return;
                const i = document.createElement('i');
                i.setAttribute('data-lucide', name);
                i.setAttribute('width', size);
                i.setAttribute('height', size);
                if (className) i.setAttribute('class', className);
                ref.current.innerHTML = '';
                ref.current.appendChild(i);
                window.lucide.createIcons({ root: ref.current });
            }, [name, size, className]);
            return <span ref={ref} className="inline-flex items-center justify-center"></span>;
        };

        // --- 工具函式 ---
        const isExpired = (dateStr) => {
            if (!dateStr) return false;
            const today = new Date().toISOString().split('T')[0];
            return new Date(dateStr).getTime() < new Date(today).getTime();
        };

        // --- 店家管理組件 ---
        function StoresManager({ supabase, onDataUpdate }) {
            const [stores, setStores] = useState([]);
            const [staffCounts, setStaffCounts] = useState({});
            const [loading, setLoading] = useState(false);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [formData, setFormData] = useState({ 
                id: null, name: '', address: '', owner_id: '', valid_until: '',
                plan_price: 300, discount: 1.0, billing_start: ''
            });

            useEffect(() => { fetchStores(); }, []);

            async function fetchStores() {
                setLoading(true);
                // 1. 抓取店家
                const { data: storesData, error } = await supabase.from('stores').select('*').order('id', { ascending: true });
                
                // 2. 抓取所有員工以計算人頭 (需 RLS 支援)
                const { data: staffData } = await supabase.from('staff').select('store_id');
                
                if (error) {
                    alert("讀取列表失敗：" + error.message);
                } else {
                    // 計算每間店的人頭數
                    const counts = {};
                    if (staffData) {
                        staffData.forEach(s => {
                            counts[s.store_id] = (counts[s.store_id] || 0) + 1;
                        });
                    }
                    setStaffCounts(counts);
                    setStores(storesData || []);
                    
                    // 回傳給父層做統計 (包含人頭數資訊)
                    if(onDataUpdate) onDataUpdate(storesData || [], counts);
                }
                setLoading(false);
            }

            const openModal = (store = null) => {
                if (store) {
                    setFormData({ 
                        id: store.id, 
                        name: store.name, 
                        address: store.address || '', 
                        owner_id: store.owner_id || '',
                        valid_until: store.valid_until || new Date().toISOString().split('T')[0],
                        plan_price: store.plan_price || 300,
                        discount: store.discount || 1.0,
                        billing_start: store.billing_start || ''
                    });
                } else {
                    const nextMonth = new Date();
                    nextMonth.setDate(nextMonth.getDate() + 30);
                    setFormData({ 
                        id: null, name: '', address: '', owner_id: '', 
                        valid_until: nextMonth.toISOString().split('T')[0],
                        plan_price: 300, discount: 1.0, billing_start: new Date().toISOString().split('T')[0]
                    });
                }
                setIsModalOpen(true);
            };

            // 智慧續約邏輯
            const handleSmartRenew = (months) => {
                const today = new Date();
                const currentValid = formData.valid_until ? new Date(formData.valid_until) : today;
                
                // 如果已經過期，從今天開始算；如果還沒過期，從原到期日往後延
                let baseDate = currentValid < today ? today : currentValid;
                
                const newDate = new Date(baseDate);
                newDate.setMonth(newDate.getMonth() + months);
                setFormData({ ...formData, valid_until: newDate.toISOString().split('T')[0] });
            };

            const handleSave = async () => {
                if (!formData.name) return alert("請填寫店名");
                
                const payload = {
                    name: formData.name,
                    address: formData.address,
                    owner_id: formData.owner_id || null,
                    valid_until: formData.valid_until,
                    plan_price: parseInt(formData.plan_price),
                    discount: parseFloat(formData.discount),
                    billing_start: formData.billing_start || null
                };

                try {
                    let error;
                    if (formData.id) {
                        const res = await supabase.from('stores').update(payload).eq('id', formData.id);
                        error = res.error;
                    } else {
                        const res = await supabase.from('stores').insert([payload]);
                        error = res.error;
                    }
                    if (error) throw error;
                    alert(formData.id ? "更新成功！" : "新增成功！");
                    setIsModalOpen(false);
                    fetchStores();
                } catch (err) {
                    alert("儲存失敗: " + err.message);
                }
            };

            return (
                <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                    <div className="flex justify-between items-center mb-6">
                        <h3 className="font-bold text-lg text-slate-700">平台店家列表</h3>
                        <button onClick={() => openModal()} className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700 flex items-center transition shadow-lg active:scale-95">
                            <Icon name="plus" size={16} className="mr-2"/> 新增店家
                        </button>
                    </div>

                    <div className="overflow-x-auto">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-indigo-50 text-indigo-900 text-xs uppercase">
                                <tr>
                                    <th className="p-3 rounded-l-lg">店名 / 訂閱制</th>
                                    <th className="p-3">帳號綁定</th>
                                    <th className="p-3">授權效期</th>
                                    <th className="p-3">預估月費</th>
                                    <th className="p-3 rounded-r-lg text-right">管理</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {loading ? <tr><td colSpan="5" className="p-8 text-center text-slate-400">載入中...</td></tr> : stores.map(store => {
                                    const expired = isExpired(store.valid_until);
                                    const count = staffCounts[store.id] || 0;
                                    const monthlyFee = Math.round(count * (store.plan_price || 300) * (store.discount || 1));
                                    
                                    return (
                                        <tr key={store.id} className="hover:bg-indigo-50/30 transition">
                                            <td className="p-4">
                                                <div className="font-bold text-slate-800 text-base">{store.name}</div>
                                                <div className="text-xs text-slate-500 mt-1 flex items-center">
                                                    <Icon name="users" size={12} className="mr-1"/> {count} 人頭
                                                    <span className="mx-2">|</span>
                                                    ${store.plan_price}/人
                                                </div>
                                            </td>
                                            <td className="p-4 font-mono text-xs text-slate-500 truncate max-w-[150px]" title={store.owner_id}>
                                                {store.owner_id ? <span className="bg-slate-100 px-2 py-1 rounded text-slate-600">{store.owner_id.slice(0,8)}...</span> : <span className="text-red-400">未綁定</span>}
                                            </td>
                                            <td className="p-4">
                                                <div className="font-mono text-slate-600 mb-1">{store.valid_until}</div>
                                                {expired ? 
                                                    <span className="bg-red-100 text-red-700 px-2 py-0.5 rounded text-[10px] font-bold inline-flex items-center"><Icon name="alert-circle" size={10} className="mr-1"/> 已過期</span> : 
                                                    <span className="bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded text-[10px] font-bold inline-flex items-center"><Icon name="check-circle" size={10} className="mr-1"/> 授權中</span>
                                                }
                                            </td>
                                            <td className="p-4">
                                                <div className="font-bold text-slate-700">${monthlyFee.toLocaleString()}</div>
                                                {store.discount < 1 && <div className="text-[10px] text-orange-500 font-bold">{(store.discount*100).toFixed(0)}折優惠</div>}
                                            </td>
                                            <td className="p-4 text-right">
                                                <button onClick={() => openModal(store)} className="text-indigo-600 hover:bg-indigo-50 p-2 rounded transition font-bold text-xs border border-indigo-200">
                                                    編輯 / 續約
                                                </button>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>

                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                            <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-lg animate-fade-in-up flex flex-col max-h-[90vh]">
                                <div className="flex justify-between items-center mb-4 border-b pb-4">
                                    <h3 className="text-xl font-bold text-slate-800">{formData.id ? '編輯店家與合約' : '新增合作店家'}</h3>
                                    <button onClick={() => setIsModalOpen(false)} className="text-slate-400 hover:text-slate-600"><Icon name="x" /></button>
                                </div>
                                <div className="space-y-4 overflow-y-auto pr-2 custom-scrollbar">
                                    {/* 基本資料 */}
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="col-span-2">
                                            <label className="block text-xs font-bold text-slate-500 mb-1">店名</label>
                                            <input className="w-full p-3 border rounded-xl bg-slate-50" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} placeholder="例如：快樂瑜珈" />
                                        </div>
                                        <div className="col-span-2">
                                            <label className="block text-xs font-bold text-slate-500 mb-1">綁定帳號 UID</label>
                                            <input className="w-full p-3 border rounded-xl bg-slate-50 text-xs font-mono" value={formData.owner_id} onChange={e => setFormData({...formData, owner_id: e.target.value})} placeholder="請輸入 User UUID" />
                                        </div>
                                    </div>

                                    {/* 合約與計費 */}
                                    <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 space-y-4">
                                        <div className="flex justify-between items-center">
                                            <label className="text-sm font-bold text-indigo-900 flex items-center"><Icon name="calendar-clock" size={16} className="mr-2"/> 授權期限</label>
                                            <div className="flex gap-1">
                                                <button onClick={() => handleSmartRenew(1)} className="px-2 py-1 bg-white border border-indigo-200 text-indigo-600 text-xs rounded hover:bg-indigo-100">+1月</button>
                                                <button onClick={() => handleSmartRenew(3)} className="px-2 py-1 bg-white border border-indigo-200 text-indigo-600 text-xs rounded hover:bg-indigo-100">+3月</button>
                                                <button onClick={() => handleSmartRenew(12)} className="px-2 py-1 bg-indigo-600 border border-indigo-600 text-white text-xs rounded hover:bg-indigo-700 shadow">+1年</button>
                                            </div>
                                        </div>
                                        <input type="date" className="w-full p-3 border border-indigo-200 rounded-xl font-bold text-indigo-900" value={formData.valid_until} onChange={e => setFormData({...formData, valid_until: e.target.value})} />
                                        
                                        <div className="grid grid-cols-2 gap-4 pt-2 border-t border-indigo-200/50">
                                            <div>
                                                <label className="block text-xs font-bold text-indigo-800 mb-1">人頭單價 ($)</label>
                                                <input type="number" className="w-full p-2 border rounded-lg" value={formData.plan_price} onChange={e => setFormData({...formData, plan_price: e.target.value})} />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-indigo-800 mb-1">折扣率 (0.1~1.0)</label>
                                                <input type="number" step="0.1" max="1" min="0" className="w-full p-2 border rounded-lg" value={formData.discount} onChange={e => setFormData({...formData, discount: e.target.value})} />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="flex justify-end space-x-2 pt-6 border-t border-gray-100 mt-4">
                                    <button onClick={() => setIsModalOpen(false)} className="px-4 py-3 text-slate-500 hover:bg-slate-100 rounded-xl font-bold">取消</button>
                                    <button onClick={handleSave} className="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-lg active:scale-95 transition">
                                        確認儲存
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- 超級管理員主程式 ---
        function SuperAdminApp() {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [loginData, setLoginData] = useState({ email: '', password: '' });
            const [loading, setLoading] = useState(false);
            const [stats, setStats] = useState({ total: 0, active: 0, revenue: 0 });

            useEffect(() => {
                const checkSession = async () => {
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    if (session) setIsLoggedIn(true);
                };
                checkSession();
            }, []);

            // 根據新的邏輯計算統計數據
            const calculateStats = (storesData, counts) => {
                const total = storesData.length;
                const active = storesData.filter(s => !isExpired(s.valid_until)).length;
                
                // 計算預估月營收
                let totalRevenue = 0;
                storesData.forEach(store => {
                    const staffCount = counts[store.id] || 0;
                    // 如果還沒到計費開始日，算0元
                    if (store.billing_start && new Date() < new Date(store.billing_start)) return;
                    
                    const fee = Math.round(staffCount * (store.plan_price || 300) * (store.discount || 1));
                    totalRevenue += fee;
                });

                setStats({ total, active, revenue: totalRevenue });
            };

            const handleLogin = async () => {
                setLoading(true);
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: loginData.email,
                    password: loginData.password
                });
                setLoading(false);
                if (error) alert("登入失敗: " + error.message);
                else setIsLoggedIn(true);
            };

            const handleLogout = async () => {
                await supabaseClient.auth.signOut();
                setIsLoggedIn(false);
                window.location.href = 'admin.html'; // 登出後跳轉
            };

            if (!isLoggedIn) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-900 p-4">
                        <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm">
                            <div className="text-center mb-6">
                                <div className="w-16 h-16 bg-indigo-600 rounded-2xl flex items-center justify-center text-white mx-auto mb-4 shadow-lg shadow-indigo-500/30">
                                    <Icon name="shield-check" size={32} />
                                </div>
                                <h2 className="text-2xl font-bold text-slate-800">平台總控登入</h2>
                                <p className="text-xs text-slate-400 mt-1">Super Admin Console</p>
                            </div>
                            <div className="space-y-4">
                                <input type="email" placeholder="管理員 Email" className="w-full p-3 border rounded-lg" value={loginData.email} onChange={e => setLoginData({...loginData, email: e.target.value})} />
                                <input type="password" placeholder="密碼" className="w-full p-3 border rounded-lg" value={loginData.password} onChange={e => setLoginData({...loginData, password: e.target.value})} />
                                <button onClick={handleLogin} disabled={loading} className="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition">
                                    {loading ? '驗證中...' : '安全登入'}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col">
                    <header className="bg-indigo-900 text-white p-4 shadow-md sticky top-0 z-10">
                        <div className="max-w-5xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-indigo-500 rounded-lg flex items-center justify-center shadow-inner">
                                    <Icon name="layout-dashboard" size={24} className="text-indigo-100" />
                                </div>
                                <div>
                                    <h1 className="font-bold text-lg leading-tight">Easybook <span className="text-indigo-300 font-normal">Platform</span></h1>
                                    <p className="text-[10px] text-indigo-300 uppercase tracking-widest font-bold">Super Admin Console</p>
                                </div>
                            </div>
                            <button onClick={handleLogout} className="bg-indigo-800 hover:bg-indigo-700 px-4 py-2 rounded-lg text-sm font-bold flex items-center transition">
                                <Icon name="log-out" size={16} className="mr-2"/> 登出
                            </button>
                        </div>
                    </header>

                    <main className="flex-1 p-6">
                        <div className="max-w-5xl mx-auto">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-indigo-100">
                                    <p className="text-xs font-bold text-indigo-300 uppercase mb-2">Total Merchants</p>
                                    <h2 className="text-4xl font-black text-slate-800">{stats.total}</h2>
                                </div>
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-indigo-100">
                                    <p className="text-xs font-bold text-indigo-300 uppercase mb-2">Active Subscriptions</p>
                                    <h2 className="text-4xl font-black text-emerald-500">{stats.active}</h2>
                                </div>
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-indigo-100">
                                    <p className="text-xs font-bold text-indigo-300 uppercase mb-2">Monthly Revenue (Est.)</p>
                                    <h2 className="text-4xl font-black text-slate-800">${stats.revenue.toLocaleString()}</h2>
                                </div>
                            </div>
                            <StoresManager supabase={supabaseClient} onDataUpdate={calculateStats} />
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SuperAdminApp />);
    </script>
</body>
</html>