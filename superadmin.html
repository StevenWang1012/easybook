<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyBook 平台總管 (SaaS Master)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; }
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        // ★ Supabase 設定 (請確認與其他檔案一致)
        const supabaseUrl = 'https://kwvbhzjzysmivafsvwng.supabase.co';
        const supabaseKey = 'sb_publishable_7RUbenk2kXNDmvuo1XtHbQ_m0RjXuZr'; 
        const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        const Icon = ({name}) => {
            React.useEffect(()=>{ if(window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} className="inline-block w-5 h-5 align-middle"></i>;
        };

        // --- 子組件：商家列表 (SaaS 視圖) ---
        function StoreList({ stores, onEdit }) {
            const copyLink = (id) => {
                // 產生通用的 admin 入口連結
                const url = window.location.href.replace('superadmin.html', `admin.html`);
                navigator.clipboard.writeText(url);
                alert("已複製通用登入連結 (請提供給店長)");
            };

            return (
                <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                    <table className="w-full text-left text-sm">
                        <thead className="bg-slate-50 border-b font-bold text-slate-500">
                            <tr>
                                <th className="p-4">商家名稱</th>
                                <th className="p-4">狀態</th>
                                <th className="p-4">到期日</th>
                                <th className="p-4">方案/折扣</th>
                                <th className="p-4">營收預估</th>
                                <th className="p-4 text-right">操作</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                            {stores.length === 0 ? <tr><td colSpan="6" className="p-8 text-center text-slate-400">尚無商家資料</td></tr> : 
                            stores.map(s => {
                                const isExpired = new Date(s.valid_until) < new Date();
                                const revenue = Math.round((s.plan_price || 0) * (s.discount || 1));
                                return (
                                    <tr key={s.id} className="hover:bg-slate-50 transition">
                                        <td className="p-4">
                                            <div className="font-bold text-slate-800">{s.name}</div>
                                            <div className="text-xs text-slate-400 font-mono">ID: {s.id.slice(0,8)}...</div>
                                        </td>
                                        <td className="p-4">
                                            {isExpired ? 
                                                <span className="bg-red-100 text-red-600 px-2 py-1 rounded text-xs font-bold flex w-fit items-center"><Icon name="alert-circle"/> 過期</span> : 
                                                <span className="bg-emerald-100 text-emerald-600 px-2 py-1 rounded text-xs font-bold flex w-fit items-center"><Icon name="check-circle"/> 營運中</span>}
                                        </td>
                                        <td className="p-4 font-mono text-slate-600">{s.valid_until}</td>
                                        <td className="p-4 text-xs">
                                            <div className="font-bold">${s.plan_price} /月</div>
                                            {s.discount < 1 && <div className="text-red-500">{(s.discount*100).toFixed(0)}% OFF</div>}
                                        </td>
                                        <td className="p-4 font-bold text-slate-700">${revenue.toLocaleString()}</td>
                                        <td className="p-4 text-right space-x-2">
                                            <button onClick={()=>onEdit(s)} className="bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 px-3 py-1 rounded-lg text-xs font-bold transition">管理</button>
                                            <button onClick={()=>copyLink(s.id)} className="bg-slate-800 text-white px-3 py-1 rounded-lg text-xs font-bold hover:bg-slate-700 transition">連結</button>
                                        </td>
                                    </tr>
                                )
                            })}
                        </tbody>
                    </table>
                </div>
            );
        }

        // --- 子組件：新增商家 (Provisioning) ---
        function CreateStoreForm({ onSubmit, loading, onSuccessClose }) {
            const [form, setForm] = useState({ name: '', email: '', password: '', plan: 365 });
            const [createdInfo, setCreatedInfo] = useState(null);

            const handleSubmit = async () => {
                const result = await onSubmit(form);
                if (result) setCreatedInfo(result);
            }

            if (createdInfo) return (
                <div className="bg-emerald-50 border border-emerald-200 rounded-2xl p-8 max-w-2xl mx-auto text-center animate-fade-in-up">
                    <div className="w-16 h-16 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4"><Icon name="check" size={32}/></div>
                    <h3 className="text-2xl font-bold text-emerald-800 mb-2">開通成功！</h3>
                    <p className="text-emerald-600 mb-6">請將以下資訊提供給商家，並請其盡快修改密碼。</p>
                    <div className="bg-white p-6 rounded-xl shadow-sm text-left max-w-sm mx-auto space-y-3 mb-6">
                        <div className="flex justify-between border-b pb-2"><span>登入帳號</span><span className="font-bold font-mono">{createdInfo.email}</span></div>
                        <div className="flex justify-between border-b pb-2"><span>預設密碼</span><span className="font-bold font-mono">{createdInfo.password}</span></div>
                        <div className="flex justify-between"><span>後台入口</span><a href="admin.html" target="_blank" className="text-blue-500 underline text-xs">開啟連結</a></div>
                    </div>
                    {/* ★ 修正：不再重新整理，而是直接關閉並返回列表 */}
                    <button onClick={onSuccessClose} className="bg-emerald-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-emerald-700 transition">完成並返回列表</button>
                </div>
            );

            return (
                <div className="bg-white rounded-2xl shadow-lg border border-slate-200 p-8 max-w-2xl mx-auto animate-fade-in-up">
                    <h3 className="text-xl font-bold text-slate-800 mb-6 flex items-center"><span className="w-2 h-6 bg-emerald-500 rounded-full mr-3"></span> 開通新商家 (SaaS Provisioning)</h3>
                    <div className="space-y-5">
                        <div>
                            <label className="block text-xs font-bold text-slate-500 mb-1 uppercase">商家名稱</label>
                            <input className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} placeholder="例如：美好瑜珈工作室"/>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1 uppercase">店長 Email (登入帳號)</label>
                                <input className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none" value={form.email} onChange={e=>setForm({...form, email:e.target.value})} placeholder="owner@example.com"/>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1 uppercase">預設密碼</label>
                                <input className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none font-mono" value={form.password} onChange={e=>setForm({...form, password:e.target.value})} placeholder="至少6碼"/>
                            </div>
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-slate-500 mb-1 uppercase">訂閱方案 (試用/付費)</label>
                            <div className="flex gap-3">
                                {[30, 90, 365].map(d => (
                                    <button key={d} onClick={()=>setForm({...form, plan:d})} className={`flex-1 py-3 rounded-xl border font-bold transition ${form.plan===d?'bg-slate-800 text-white border-slate-800':'bg-white text-slate-500 hover:bg-slate-50'}`}>
                                        {d} 天 {d===365 && '(年繳)'}
                                    </button>
                                ))}
                            </div>
                        </div>
                        <div className="bg-amber-50 text-amber-700 text-xs p-3 rounded-lg flex items-start">
                            <Icon name="alert-triangle" className="mr-2 flex-shrink-0"/>
                            <span>注意：點擊開通後，系統將自動註冊 Auth 帳號並寫入資料庫。</span>
                        </div>
                        <button onClick={handleSubmit} disabled={loading} className="w-full bg-emerald-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-emerald-700 transition active:scale-95">
                            {loading ? '系統處理中...' : '確認開通並建立帳號'}
                        </button>
                    </div>
                </div>
            );
        }

        // --- 主程式 ---
        function SuperAdminApp() {
            const [stores, setStores] = useState([]);
            const [view, setView] = useState('list');
            const [loading, setLoading] = useState(false);
            const [isAuth, setIsAuth] = useState(false);
            const [login, setLogin] = useState({email:'', password:''});
            const [editStore, setEditStore] = useState(null);

            // 1. 登入邏輯
            const handleLogin = async () => {
                setLoading(true);
                // 這裡可加強：使用 RPC check_platform_admin 驗證
                const { data, error } = await supabaseClient.auth.signInWithPassword(login);
                if (error) alert("登入失敗: " + error.message); else checkAuth();
                setLoading(false);
            };
            const checkAuth = async () => {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (user) { setIsAuth(true); fetchStores(); }
            };

            // 2. 讀取數據 (優先 RPC，失敗則 Select)
            const fetchStores = async () => {
                setLoading(true);
                const { data: rpcData, error: rpcError } = await supabaseClient.rpc('get_all_stores_admin');
                if (!rpcError) {
                    setStores(rpcData);
                } else {
                    const { data } = await supabaseClient.from('stores').select('*').order('created_at', { ascending: false });
                    setStores(data || []);
                }
                setLoading(false);
            };

            // 3. 建立商家 (傳回帳密供顯示) - ★ 修復重點：防止登出
            const handleCreate = async (form) => {
                if(!form.email || !form.password) { alert("資料不完整"); return null; }
                setLoading(true);
                try {
                    // ★ 關鍵修正：使用隔離的暫存 Client 進行註冊
                    // 這能避免污染當前 SuperAdmin 的 Session
                    const tempClient = window.supabase.createClient(supabaseUrl, supabaseKey, {
                        auth: {
                            autoRefreshToken: false,
                            persistSession: false,
                            detectSessionInUrl: false
                        }
                    });

                    // A. 註冊帳號 (使用 tempClient)
                    const { data: authData, error: authError } = await tempClient.auth.signUp({ 
                        email: form.email, 
                        password: form.password 
                    });
                    
                    if(authError) throw authError;
                    const userId = authData.user?.id;
                    
                    // B. 寫入資料庫 (使用原本的 Client，因為 SuperAdmin 才有寫入權限)
                    const validUntil = new Date(); validUntil.setDate(validUntil.getDate() + form.plan);
                    const { error: dbError } = await supabaseClient.from('stores').insert([{
                        owner_id: userId,
                        name: form.name,
                        valid_until: validUntil.toISOString().split('T')[0],
                        plan_price: form.plan === 365 ? 12000 : 3000,
                        discount: 1.0, 
                        billing_start: new Date().toISOString().split('T')[0], 
                        open_time: '09:00', close_time: '21:00'
                    }]);
                    if(dbError) throw dbError;

                    // 成功回傳
                    return { ...form };
                } catch(err) { 
                    alert("錯誤: " + err.message); 
                    return null;
                } finally { setLoading(false); }
            };

            // 4. 更新商家 (含智慧續約邏輯)
            const handleUpdate = async () => {
                const { error } = await supabaseClient.rpc('super_admin_update_store', {
                    p_store_id: editStore.id,
                    p_name: editStore.name,
                    p_valid_until: editStore.valid_until,
                    p_plan_price: parseInt(editStore.plan_price)
                });
                
                if(error) alert("失敗: "+error.message); else { setEditStore(null); fetchStores(); }
            };

            // 智慧續約計算
            const extendDate = (days) => {
                const current = new Date(editStore.valid_until);
                const now = new Date();
                // 若已過期，從今天開始加；若未過期，從到期日開始加
                const base = current < now ? now : current;
                base.setDate(base.getDate() + days);
                setEditStore({ ...editStore, valid_until: base.toISOString().split('T')[0] });
            };

            const stats = stores.reduce((acc,s) => {
                acc.total++;
                if(new Date(s.valid_until) > new Date()) { 
                    acc.active++; 
                    acc.rev += Math.round((s.plan_price||0) * (s.discount||1)); 
                }
                return acc;
            }, {total:0, active:0, rev:0});

            if (!isAuth) return (
                <div className="min-h-screen flex items-center justify-center bg-slate-200">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-96 text-center border-t-4 border-slate-800">
                        <div className="mb-6"><Icon name="shield" size={48} className="text-slate-800"/></div>
                        <h2 className="text-2xl font-black mb-6 text-slate-800">EasyBook 總控中心</h2>
                        <input className="w-full p-4 bg-slate-50 border border-slate-200 mb-3 rounded-xl focus:ring-2 focus:ring-slate-800 outline-none" placeholder="管理員帳號" value={login.email} onChange={e=>setLogin({...login, email:e.target.value})}/>
                        <input type="password" className="w-full p-4 bg-slate-50 border border-slate-200 mb-6 rounded-xl focus:ring-2 focus:ring-slate-800 outline-none" placeholder="密碼" value={login.password} onChange={e=>setLogin({...login, password:e.target.value})}/>
                        <button onClick={handleLogin} disabled={loading} className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold hover:bg-slate-800 transition transform active:scale-95">{loading?"驗證中...":"登入系統"}</button>
                    </div>
                </div>
            );

            return (
                <div className="flex h-screen bg-slate-100">
                    <aside className="w-64 bg-slate-900 text-white flex-shrink-0 flex flex-col">
                        <div className="p-6 border-b border-slate-800">
                            <h1 className="text-xl font-bold flex items-center tracking-wider"><Icon name="layout-grid" className="mr-3"/> EasyBook</h1>
                            <span className="text-[10px] bg-slate-800 text-slate-400 px-2 py-1 rounded mt-2 inline-block">SaaS Admin V3.4</span>
                        </div>
                        <nav className="p-4 space-y-2 flex-1">
                            <button onClick={()=>setView('list')} className={`w-full text-left p-3 rounded-xl font-bold transition flex items-center ${view==='list'?'bg-emerald-600 text-white shadow-lg':'text-slate-400 hover:bg-slate-800 hover:text-white'}`}><Icon name="users" className="mr-3"/> 商家管理</button>
                            <button onClick={()=>setView('create')} className={`w-full text-left p-3 rounded-xl font-bold transition flex items-center ${view==='create'?'bg-emerald-600 text-white shadow-lg':'text-slate-400 hover:bg-slate-800 hover:text-white'}`}><Icon name="plus-circle" className="mr-3"/> 開通商家</button>
                        </nav>
                        <div className="p-4 border-t border-slate-800">
                            <button onClick={()=>window.location.reload()} className="flex items-center text-slate-400 hover:text-white transition w-full p-2 font-bold"><Icon name="log-out" className="mr-2"/> 登出系統</button>
                        </div>
                    </aside>
                    
                    <main className="flex-1 p-8 overflow-y-auto">
                        <header className="flex justify-between items-center mb-8">
                            <div>
                                <h2 className="text-3xl font-black text-slate-800">{view==='list'?'營運儀表板':'新增合作商家'}</h2>
                                <p className="text-slate-500 mt-1">{view==='list'?'監控平台營收與商家狀態':'為新客戶開通專屬後台'}</p>
                            </div>
                            <div className="text-right">
                                <div className="text-sm font-bold text-slate-400 uppercase">Total Revenue</div>
                                <div className="text-2xl font-black text-emerald-600">${stats.rev.toLocaleString()}</div>
                            </div>
                        </header>
                        
                        {view === 'list' && (
                            <>
                                <div className="grid grid-cols-3 gap-6 mb-8">
                                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center">
                                        <div className="p-4 bg-blue-50 text-blue-600 rounded-xl mr-4"><Icon name="store" size={24}/></div>
                                        <div><div className="text-slate-400 text-xs font-bold uppercase">總店家數</div><div className="text-3xl font-black text-slate-800">{stats.total}</div></div>
                                    </div>
                                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center">
                                        <div className="p-4 bg-emerald-50 text-emerald-600 rounded-xl mr-4"><Icon name="activity" size={24}/></div>
                                        <div><div className="text-slate-400 text-xs font-bold uppercase">活躍訂閱</div><div className="text-3xl font-black text-emerald-600">{stats.active}</div></div>
                                    </div>
                                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center">
                                        <div className="p-4 bg-purple-50 text-purple-600 rounded-xl mr-4"><Icon name="credit-card" size={24}/></div>
                                        <div><div className="text-slate-400 text-xs font-bold uppercase">平均客單</div><div className="text-3xl font-black text-purple-600">${stats.total ? Math.round(stats.rev/stats.total).toLocaleString() : 0}</div></div>
                                    </div>
                                </div>
                                <StoreList stores={stores} onEdit={setEditStore} />
                            </>
                        )}

                        {view === 'create' && <CreateStoreForm onSubmit={handleCreate} loading={loading} onSuccessClose={() => { setView('list'); fetchStores(); }} />}
                    </main>

                    {/* Edit Modal (SaaS 完整版) */}
                    {editStore && (
                        <div className="fixed inset-0 bg-slate-900/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
                            <div className="bg-white p-8 rounded-2xl w-full max-w-lg shadow-2xl animate-fade-in-up">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-bold text-slate-800">商家合約管理</h3>
                                    <button onClick={()=>setEditStore(null)} className="text-slate-400 hover:text-slate-600"><Icon name="x"/></button>
                                </div>
                                
                                <div className="space-y-5 mb-8">
                                    <div><label className="text-xs font-bold text-slate-400 mb-1 block">商家名稱</label><input className="w-full p-3 border rounded-xl font-bold text-slate-800" value={editStore.name} onChange={e=>setEditStore({...editStore, name:e.target.value})}/></div>
                                    
                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                        <label className="text-xs font-bold text-emerald-600 mb-2 block flex items-center"><Icon name="clock" size={14} className="mr-1"/> 合約到期日 (智慧續約)</label>
                                        <div className="flex gap-2 mb-2">
                                            <input type="date" className="flex-1 p-2 border rounded-lg bg-white" value={editStore.valid_until} onChange={e=>setEditStore({...editStore, valid_until:e.target.value})}/>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={()=>extendDate(30)} className="flex-1 bg-white border border-emerald-200 text-emerald-700 py-2 rounded-lg text-xs font-bold hover:bg-emerald-50 transition">+30天</button>
                                            <button onClick={()=>extendDate(90)} className="flex-1 bg-white border border-emerald-200 text-emerald-700 py-2 rounded-lg text-xs font-bold hover:bg-emerald-50 transition">+1季</button>
                                            <button onClick={()=>extendDate(365)} className="flex-1 bg-emerald-600 text-white py-2 rounded-lg text-xs font-bold hover:bg-emerald-700 transition shadow">+1年</button>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="text-xs font-bold text-slate-400 mb-1 block">月費 (SaaS Plan)</label><input type="number" className="w-full p-3 border rounded-xl" value={editStore.plan_price} onChange={e=>setEditStore({...editStore, plan_price:e.target.value})}/></div>
                                        <div><label className="text-xs font-bold text-slate-400 mb-1 block">折扣率 (1.0=原價)</label><input type="number" step="0.1" className="w-full p-3 border rounded-xl" value={editStore.discount || 1.0} onChange={e=>setEditStore({...editStore, discount:e.target.value})}/></div>
                                    </div>
                                </div>

                                <div className="flex gap-3">
                                    <button onClick={()=>setEditStore(null)} className="flex-1 py-3 bg-slate-100 rounded-xl font-bold text-slate-500 hover:bg-slate-200 transition">取消</button>
                                    <button onClick={handleUpdate} className="flex-1 py-3 bg-slate-900 text-white rounded-xl font-bold shadow-xl hover:bg-slate-800 transition">確認變更</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SuperAdminApp />);
    </script>
</body>
</html>